<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Matside â€” Scoreboard</title>

<!-- Socket.IO client from your server -->
<script src="https://scoreboard-server-er33.onrender.com/socket.io/socket.io.js"></script>

<style>
  :root{
    --bg:#000000;
    --panel:#111216;
    --muted:#9aa0a6;
    --red:#d32f2f;
    --green:#00c853;
    --gold:#fbc02d;
  }

  html,body{
    margin:0;padding:0;background:#000;color:#fff;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }
  .wrap{
    max-width:820px;margin:0 auto;padding:10px;
  }
  table{
    width:100%;border-collapse:collapse;
    table-layout:fixed;
  }
  td{
    padding:4px 6px;text-align:center;
  }
  .label{
    font-size:14px;font-weight:700;
    background:#111216;
    text-transform:uppercase;
  }
  .mat-num, .period-num{
    font-size:32px;font-weight:800;
  }
  .timer-label{
    font-size:16px;font-weight:700;
    padding-top:8px;
  }
  .timer{
    font-size:60px;font-weight:800;
    padding:6px 0;
  }

  @keyframes timerPulse {
    0%{opacity:1;} 50%{opacity:.4;} 100%{opacity:1;}
  }
  .timer-running{
    animation:timerPulse 1.2s infinite;
  }
  .timer-zero{
    color:var(--gold);
  }

  .name{
    font-size:20px;font-weight:700;opacity:.9;
  }
  .name-red{color:var(--red);}
  .name-green{color:var(--green);}

  .score-row td{
    padding:8px 4px;
  }
  .score-box{
    font-size:110px;font-weight:900;
  }
  .score-red{
    background:var(--red);
  }
  .score-green{
    background:var(--green);
    color:#000;
  }

  .branding-row td{
    padding-top:6px;
  }
  .branding{
    font-size:11px;color:var(--muted);
    opacity:.8;
  }

  .winner-tag{
    display:inline-block;
    margin-left:6px;
    padding:2px 6px;
    border-radius:999px;
    background:var(--gold);
    color:#000;
    font-size:11px;
    font-weight:700;
  }
</style>
</head>
<body>

<div class="wrap">
  <table>
    <tbody>
      <!-- HEADER -->
      <tr>
        <td class="label" style="width:18%;">MAT</td>
        <td class="label" style="width:52%;" colspan="2">MATSIDE SCOREBOARD</td>
        <td class="label" style="width:18%;">PERIOD</td>
      </tr>
      <tr>
        <td><div id="matNumber" class="mat-num">1</div></td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td><div id="periodNumber" class="period-num">1</div></td>
      </tr>

      <!-- TIMER -->
      <tr>
        <td colspan="4" class="timer-label">TIME</td>
      </tr>
      <tr>
        <td colspan="4">
          <div id="timer" class="timer">00:00</div>
        </td>
      </tr>

      <!-- NAMES -->
      <tr>
        <td id="redName" class="name name-red" colspan="2">RED WRESTLER</td>
        <td id="greenName" class="name name-green" colspan="2">GREEN WRESTLER</td>
      </tr>

      <!-- SCORES -->
      <tr class="score-row">
        <td class="score-red score-box" colspan="2">
          <span id="scoreRed">0</span>
        </td>
        <td class="score-green score-box" colspan="2">
          <span id="scoreGreen">0</span>
        </td>
      </tr>

      <!-- BRANDING -->
      <tr class="branding-row">
        <td colspan="4">
          <div class="branding">
            Matside &mdash; Live Mat Scoreboard
          </div>
        </td>
      </tr>

    </tbody>
  </table>
</div>

<script>
  // ---- Which mat? Get from ?mat=1,2,3,4 (default 1) ----
  function getMatFromQuery(){
    const params = new URLSearchParams(window.location.search);
    const m = parseInt(params.get("mat"), 10);
    if(!m || m < 1 || m > 4) return 1;
    return m;
  }
  const MAT_ID = getMatFromQuery();
  document.getElementById("matNumber").textContent = MAT_ID;

  // ---- Socket.IO ----
  const socket = io("https://scoreboard-server-er33.onrender.com", {
    transports:["websocket","polling"]
  });

  const timerEl = document.getElementById("timer");
  const periodEl = document.getElementById("periodNumber");
  const scoreRedEl = document.getElementById("scoreRed");
  const scoreGreenEl = document.getElementById("scoreGreen");
  const redNameEl = document.getElementById("redName");
  const greenNameEl = document.getElementById("greenName");

  function formatTime(sec){
    const s = Math.max(0, sec || 0);
    const m = String(Math.floor(s/60)).padStart(2,"0");
    const r = String(s%60).padStart(2,"0");
    return `${m}:${r}`;
  }

  socket.on("stateUpdate", (state) => {
    const m = state.mats?.[MAT_ID];
    if(!m) return;

    // Time: countdown (server already decrements)
    const t = m.time ?? 0;
    timerEl.textContent = formatTime(t);

    // running pulse
    if(m.running){
      timerEl.classList.add("timer-running");
    }else{
      timerEl.classList.remove("timer-running");
    }

    // flash / style at 0:00
    if(t <= 0){
      timerEl.classList.add("timer-zero");
    }else{
      timerEl.classList.remove("timer-zero");
    }

    // Period + scores
    periodEl.textContent = m.period ?? 1;
    scoreRedEl.textContent = m.red ?? 0;
    scoreGreenEl.textContent = m.green ?? 0;

    // winner tag at end of match if scores differ and clock is 0 and not running
    // (simple visual indicator, can refine later)
    cleanWinnerTags();
    if(t <= 0 && !m.running && (m.red ?? 0) !== (m.green ?? 0)){
      if((m.red ?? 0) > (m.green ?? 0)){
        attachWinner(redNameEl);
      }else{
        attachWinner(greenNameEl);
      }
    }
  });

  function cleanWinnerTags(){
    document.querySelectorAll(".winner-tag").forEach(el => el.remove());
  }

  function attachWinner(nameEl){
    const tag = document.createElement("span");
    tag.className = "winner-tag";
    tag.textContent = "WINNER";
    nameEl.appendChild(tag);
  }

  // (Optional) pull local names from control panel storage if same browser
  try{
    const raw = localStorage.getItem("matsideNames");
    if(raw){
      const names = JSON.parse(raw);
      const matNames = names[MAT_ID] || {};
      if(matNames.red) redNameEl.textContent = matNames.red;
      if(matNames.green) greenNameEl.textContent = matNames.green;
    }
  }catch(e){
    // ignore
  }
</script>

</body>
</html>
