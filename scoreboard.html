<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matside â€” Scoreboard v3.2</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  :root {
    --bg: #070809;
    --panel: rgba(22, 24, 28, 0.8);
    --border: rgba(255,255,255,0.08);

    --red-back: #1a0000;
    --red-glow: #ff4444;

    --green-back: #001a00;
    --green-glow: #66ff66;

    --radius: 20px;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: white;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    padding: 20px;
  }

  .scoreboard {
    max-width: 1100px;
    margin: 0 auto;
    padding: 18px;
    background: var(--panel);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: 0 8px 28px rgba(0,0,0,0.45);
    backdrop-filter: blur(10px);
  }

  /* TOP BAR: MAT | TIMER | PERIOD */
  .top-row {
    display: grid;
    grid-template-columns: 1fr 1.4fr 1fr;
    gap: 18px;
    margin-bottom: 20px;
  }

  .top-box {
    background: rgba(255,255,255,0.06);
    text-align: center;
    padding: 18px 0;
    border-radius: var(--radius);
    font-weight: 800;
    font-size: 22px;
    border: 1px solid var(--border);
  }

  .timer-box {
    font-size: 80px;
    padding: 10px 0;
    font-weight: 800;
  }

  .period-box {
    font-size: 28px;
    font-weight: 800;
  }

  /* NAMES */
  .name-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-bottom: 14px;
  }

  .red-name {
    text-align: center;
    font-size: 30px;
    font-weight: 800;
    color: var(--red-glow);
  }
  .green-name {
    text-align: center;
    font-size: 30px;
    font-weight: 800;
    color: var(--green-glow);
  }

  /* SCORES */
  .score-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }

  .score-box {
    padding: 45px 0;
    font-size: 110px;
    font-weight: 900;
    text-align: center;
    border-radius: var(--radius);
  }

  .red-score {
    background: var(--red-back);
    border: 2px solid var(--red-glow);
    box-shadow: 0 0 20px var(--red-glow);
  }
  .green-score {
    background: var(--green-back);
    border: 2px solid var(--green-glow);
    box-shadow: 0 0 20px var(--green-glow);
  }
</style>
</head>
<body>

<div class="scoreboard">

  <div class="top-row">
    <div class="top-box" id="sb-mat">MAT 1</div>
    <div class="top-box timer-box" id="sb-time">00:00</div>
    <div class="top-box period-box" id="sb-period">PERIOD 1</div>
  </div>

  <div class="name-row">
    <div class="red-name" id="sb-red-name">RED</div>
    <div class="green-name" id="sb-green-name">GREEN</div>
  </div>

  <div class="score-row">
    <div class="score-box red-score" id="sb-p1">0</div>
    <div class="score-box green-score" id="sb-p2">0</div>
  </div>

</div>

<script>
const socket = io("https://scoreboard-server-er33.onrender.com");

// ======= Presence & Diagnostics: Scoreboard =======
const urlParams = new URLSearchParams(window.location.search);
const sbMat = parseInt(urlParams.get("mat") || "1", 10);

let sbReconnects = 0;
let sbStart = Date.now();
let sbFps = 0;
let sbFrameCount = 0;
let sbLastFpsSample = performance.now();

if (socket.io) {
  socket.io.on("reconnect", () => {
    sbReconnects++;
  });
}

function trackScoreboardFps(ts) {
  sbFrameCount++;
  if (ts - sbLastFpsSample >= 1000) {
    sbFps = sbFrameCount;
    sbFrameCount = 0;
    sbLastFpsSample = ts;
  }
  requestAnimationFrame(trackScoreboardFps);
}
requestAnimationFrame(trackScoreboardFps);

// Heartbeat every 8s
setInterval(() => {
  socket.emit("heartbeat", {
    type: "scoreboard",
    mat: sbMat,
    ts: Date.now()
  });
}, 8000);

// Diagnostics every 15s
setInterval(() => {
  const uptime = Math.round((Date.now() - sbStart) / 1000);
  const mem = performance.memory ? performance.memory.usedJSHeapSize : null;

  socket.emit("clientDiagnostics", {
    type: "scoreboard",
    mat: sbMat,
    fps: sbFps,
    uptime,
    reconnects: sbReconnects,
    usedHeap: mem
  });
}, 15000);
  
function formatTime(sec) {
  const m = Math.floor(sec / 60).toString().padStart(2,"0");
  const s = (sec % 60).toString().padStart(2,"0");
  return `${m}:${s}`;
}

socket.on("stateUpdate", (state) => {
  const urlParams = new URLSearchParams(window.location.search);
  const mat = parseInt(urlParams.get("mat") || "1");
  const m = state.mats[mat];
  if (!m) return;

  document.getElementById("sb-mat").textContent = `MAT ${mat}`;
  document.getElementById("sb-period").textContent = `PERIOD ${m.period}`;
  document.getElementById("sb-time").textContent = formatTime(m.time);

  document.getElementById("sb-red-name").textContent = m.redName || "RED";
  document.getElementById("sb-green-name").textContent = m.greenName || "GREEN";

  document.getElementById("sb-p1").textContent = m.red;
  document.getElementById("sb-p2").textContent = m.green;
});
</script>

</body>
</html>
