<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Matside — Scoreboard v2.5.3</title>

<!-- Load Socket.IO from your server -->
<script src="https://scoreboard-server-er33.onrender.com/socket.io/socket.io.js"></script>

<style>
  :root {
    --red: #d32f2f;
    --green: #00c853;
    --panel: #111216;
    --bg: #000;
    --muted: #888;
    --gold: #fbc02d;
  }

  html, body {
    margin:0; padding:0; background:#000; color:#fff;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    text-align:center;
  }

  #scoreboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 6px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  td {
    padding: 4px;
  }

  .label {
    background: var(--panel);
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .mat-num, .period-num {
    font-size: 40px;
    font-weight: 800;
  }

  .timer {
    font-size: 160px;
    font-weight: 900;
    padding: 6px 0;
  }

  @keyframes timerPulse {
    0% { opacity:1; }
    50% { opacity:.4; }
    100% { opacity:1; }
  }
  .timer-running {
    animation: timerPulse 1.1s infinite ease-in-out;
  }
  .timer-zero {
    color: var(--gold);
  }

  .name {
    font-size: 40px;
    font-weight: 700;
    opacity: .9;
  }

  .name-red {
    color: var(--red);
  }
  .name-green {
    color: var(--green);
  }
.score-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 16px;
  }
  .score-box {
    font-size: 220px;
    font-weight: 900;
    padding: 40px 0;
    border-radius: 16px;
  }
  .score-red {
    background: var(--red);
    color: #fff;
  }
  .score-green {
    background: var(--green);
    color: #000;
  }

  .winner-tag {
    display: inline-block;
    margin-left: 6px;
    padding: 2px 6px;
    border-radius: 999px;
    background: var(--gold);
    color: #000;
    font-size: 12px;
    font-weight: 700;
  }

  .branding {
    font-size: 12px;
    color: var(--muted);
    padding-top: 6px;
  }
</style>
</head>

<body>

<div id="scoreboard">
  <table>
    <tbody>

      <!-- HEADER -->
      <tr>
        <td class="label">MAT</td>
        <td class="label" colspan="2">MATSIDE SCOREBOARD</td>
        <td class="label">PERIOD</td>
      </tr>

      <tr>
        <td><div id="matNumber" class="mat-num">1</div></td>
        <td></td>
        <td></td>
        <td><div id="periodNumber" class="period-num">1</div></td>
      </tr>

      <!-- TIMER -->
      <tr>
        <td colspan="4" class="label">TIME</td>
      </tr>

      <tr>
        <td colspan="4">
          <div id="timer" class="timer">00:00</div>
        </td>
      </tr>

      <!-- WRESTLER NAMES -->
      <tr>
        <td id="redName" class="name name-red" colspan="2">RED WRESTLER</td>
        <td id="greenName" class="name name-green" colspan="2">GREEN WRESTLER</td>
      </tr>

      <!-- SCORES -->
      <tr>
        <td class="score-box score-red" colspan="2">
          <span id="scoreRed">0</span>
        </td>
        <td class="score-box score-green" colspan="2">
          <span id="scoreGreen">0</span>
        </td>
      </tr>

      <!-- BRANDING -->
      <tr>
        <td colspan="4">
          <div class="branding">Matside — Live Mat View</div>
        </td>
      </tr>

    </tbody>
  </table>
</div>

<script>
/* ============================================================
   MAT SELECTION
============================================================ */
function getMatID() {
  const params = new URLSearchParams(window.location.search);
  const id = parseInt(params.get("mat"), 10);
  return (id >= 1 && id <= 4) ? id : 1;
}
const MAT_ID = getMatID();
document.getElementById("matNumber").textContent = MAT_ID;

/* ============================================================
   SOCKET.IO
============================================================ */
const socket = io("https://scoreboard-server-er33.onrender.com", {
  transports:["websocket","polling"]
});

socket.on("stateUpdate", (state) => {
  const m = state.mats?.[MAT_ID];
  if (!m) return;

  updateTime(m);
  updateScores(m);
  updateNames(m);
});

/* ============================================================
   TIME DISPLAY
============================================================ */
const timerEl = document.getElementById("timer");

function formatTime(sec) {
  sec = Math.max(0, sec);
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}

function updateTime(m) {
  timerEl.textContent = formatTime(m.time);

  if (m.running) {
    timerEl.classList.add("timer-running");
  } else {
    timerEl.classList.remove("timer-running");
  }

  if (m.time <= 0) {
    timerEl.classList.add("timer-zero");
  } else {
    timerEl.classList.remove("timer-zero");
  }

  document.getElementById("periodNumber").textContent = m.period;
}

/* ============================================================
   SCORE DISPLAY
============================================================ */
function updateScores(m) {
  document.getElementById("scoreRed").textContent = m.red ?? 0;
  document.getElementById("scoreGreen").textContent = m.green ?? 0;

  // winner indicator for finished match
  removeWinnerTags();

  if (m.time <= 0 && !m.running && m.red !== m.green) {
    if (m.red > m.green) attachWinner(document.getElementById("redName"));
    else attachWinner(document.getElementById("greenName"));
  }
}

function removeWinnerTags() {
  document.querySelectorAll(".winner-tag").forEach(el => el.remove());
}
function attachWinner(el) {
  const tag = document.createElement("span");
  tag.className = "winner-tag";
  tag.textContent = "WINNER";
  el.appendChild(tag);
}

/* ============================================================
   NAME PRIORITY (C)
   1) events.json (future)
   2) localStorage (control panel local override)
   3) defaults
============================================================ */
function updateNames(m) {
  const redEl = document.getElementById("redName");
  const greenEl = document.getElementById("greenName");

  // --- 1. Events.json support coming soon ---
  // for now always fall through to local / default

  // --- 2. Local control panel names ---
  try {
    const raw = localStorage.getItem("matsideNames");
    if (raw) {
      const names = JSON.parse(raw);
      if (names[MAT_ID]?.red) redEl.textContent = names[MAT_ID].red;
      if (names[MAT_ID]?.green) greenEl.textContent = names[MAT_ID].green;
      return;
    }
  } catch(e) {}

  // --- 3. Defaults ---
  redEl.textContent = "RED WRESTLER";
  greenEl.textContent = "GREEN WRESTLER";
}
</script>

</body>
</html>
