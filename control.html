<!doctype html>
<html lang="en" data-skin="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matside — Control Panel</title>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- Shared UI Kit (new system) -->
  <link rel="stylesheet" href="./modules/core/ui-kit.css" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      background: var(--ms-bg, #05060a);
      color: var(--ms-text, #f8f9ff);
    }

    /* HEADER */
    .ms-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: var(--ms-panel, #10121a);
      border-bottom: 1px solid var(--ms-panel-border, #181a24);
    }
    .ms-header-logo {
      height: 40px;
      border-radius: 10px;
    }
    .ms-header-title {
      font-size: 20px;
      font-weight: 700;
    }

    .ms-wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    /* TOP BAR */
    .ms-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .ms-topbar-middle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .ms-topbar select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 0;
      background: var(--ms-input-bg, #0e1016);
      color: var(--ms-text, #fff);
    }

    /* SUMMARY BAR */
    .ms-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: space-between;
      padding: 10px 14px;
      margin-bottom: 16px;
      border-radius: 14px;
      background: var(--ms-panel, #10121a);
      box-shadow: 0 10px 25px rgba(0,0,0,0.55);
      font-size: 14px;
    }
    .ms-summary-item strong {
      font-weight: 800;
      font-size: 16px;
    }
    .ms-summary-red {
      color: var(--ms-red, #ff5252);
    }
    .ms-summary-green {
      color: var(--ms-green, #66ff99);
    }

    /* CARDS */
    .ms-card {
      background: var(--ms-panel, #10121a);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.55);
    }
    .ms-card h3 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 700;
    }

    .ms-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button.ms-btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
    }
    .ms-btn-blue {
      background: var(--ms-accent, #2f8cff);
      color: #fff;
    }
    .ms-btn-gray {
      background: var(--ms-btn-bg, #23262f);
      color: var(--ms-text-muted, #d0d4e4);
    }
    .ms-btn-gold {
      background: var(--ms-gold, #fbc02d);
      color: #000;
    }
    .ms-btn-red {
      background: var(--ms-red, #ff5252);
      color: #fff;
    }
    .ms-btn-green {
      background: var(--ms-green, #66ff99);
      color: #000;
    }

    .ms-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 800px) {
      .ms-grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .ms-scoring-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    /* TIMER PULSE */
    @keyframes msTimerPulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .ms-timer-running {
      animation: msTimerPulse 1.1s infinite ease-in-out;
    }

    /* DRAWERS */
    .ms-drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 900;
    }
    .ms-drawer-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .ms-drawer {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 320px;
      max-width: 80vw;
      background: var(--ms-panel, #10121a);
      box-shadow: 0 0 30px rgba(0,0,0,0.75);
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    #drawerLeft {
      left: 0;
      transform: translateX(-100%);
    }
    #drawerLeft.open {
      transform: translateX(0);
    }
    #drawerRight.open {
      transform: translateX(0);
    }

    .ms-drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--ms-panel-border, #181a24);
    }
    .ms-drawer-title {
      font-size: 15px;
      font-weight: 700;
    }
    .ms-drawer-body {
      padding: 14px 16px;
      font-size: 13px;
      overflow-y: auto;
    }
    .ms-drawer-section {
      margin-bottom: 18px;
    }
    .ms-drawer-note {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.65;
    }
    .ms-drawer input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 0;
      background: var(--ms-input-bg, #0e1016);
      color: var(--ms-text, #fff);
      margin-top: 4px;
    }

    /* TIMELINE IN DRAWER */
    #timelineBox {
      background: var(--ms-panel-subtle, #090b10);
      border-radius: 10px;
      padding: 8px;
      max-height: 240px;
      overflow-y: auto;
      font-size: 12px;
    }
    .tl-item {
      padding: 6px 8px;
      border-radius: 6px;
      background: var(--ms-panel-soft, #151826);
      margin-bottom: 4px;
    }

    /* MATCH END MODAL UI (for existing match-end.js) */
    .ms-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 1100;
    }
    .ms-modal-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }
    .ms-modal {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 1200;
    }
    .ms-modal.open {
      opacity: 1;
      pointer-events: auto;
    }
    .ms-modal-card {
      width: 100%;
      max-width: 380px;
      background: var(--ms-panel, #10121a);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.8);
      font-size: 14px;
    }
    .ms-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .ms-modal-title {
      font-weight: 700;
      font-size: 16px;
    }
    .ms-pill-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }
    .ms-pill-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--ms-panel-border, #1e2230);
      font-size: 13px;
      background: transparent;
      color: var(--ms-text, #fff);
      cursor: pointer;
    }
    .ms-pill-btn[data-victory]:hover {
      border-color: var(--ms-accent, #2f8cff);
    }

    /* Simple local toast used by match-end.js */
    #lastMatchToast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 13px;
      display: none;
      z-index: 1300;
    }

    #version-tag {
      position: fixed;
      bottom: 6px;
      right: 10px;
      font-size: 11px;
      opacity: 0.65;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="ms-header">
    <img src="./assets/image01.png" alt="Matside" class="ms-header-logo" />
    <div class="ms-header-title">Matside Control Panel</div>
  </header>

  <main class="ms-wrap">
    <!-- TOP BAR -->
    <div class="ms-topbar">
      <button id="openLeft" class="ms-btn ms-btn-gray">⚙ Timer Settings</button>

      <div class="ms-topbar-middle">
        <span>Mat</span>
        <select id="matSelect">
          <option value="1">Mat 1</option>
          <option value="2">Mat 2</option>
          <option value="3">Mat 3</option>
          <option value="4">Mat 4</option>
        </select>
        <span>Status: <span id="conn">connecting…</span></span>
      </div>

      <button id="openRight" class="ms-btn ms-btn-gray">☰ Match Settings</button>
    </div>

    <!-- SUMMARY -->
    <section class="ms-summary">
      <div class="ms-summary-item">
        Mat<br /><strong id="sumMat">1</strong>
      </div>
      <div class="ms-summary-item">
        Segment<br /><strong id="sumSeg">P1</strong>
      </div>
      <div class="ms-summary-item">
        Time<br /><strong id="sumTime">01:00</strong>
      </div>
      <div class="ms-summary-item">
        Red<br /><strong id="sumRed" class="ms-summary-red">0</strong>
      </div>
      <div class="ms-summary-item">
        Green<br /><strong id="sumGreen" class="ms-summary-green">0</strong>
      </div>
    </section>

    <!-- TIMER CARD -->
    <section class="ms-card">
      <h3>Timer</h3>
      <div class="ms-row" style="margin-bottom:8px;">
        <button id="startBtn" class="ms-btn ms-btn-blue">Start</button>
        <button id="stopBtn" class="ms-btn ms-btn-gray">Stop</button>
        <button id="endMatchBtn" class="ms-btn ms-btn-gold">End Match</button>
      </div>
      <div class="ms-row">
        <button id="resetTimerBtn" class="ms-btn ms-btn-gray">Reset Timer</button>
      </div>
      <div style="margin-top:8px;font-size:12px;opacity:0.7;">
        Regulation presets &amp; custom time live in the Timer Settings drawer.
      </div>
    </section>

    <!-- SCORING CARD -->
    <section class="ms-card">
      <h3>Scoring</h3>
      <div class="ms-grid-2">
        <!-- RED -->
        <div>
          <div style="font-size:13px;margin-bottom:4px;">Red Wrestler</div>
          <div class="ms-scoring-grid">
            <button class="ms-btn ms-btn-red" data-color="red" data-pts="1">E1</button>
            <button class="ms-btn ms-btn-red" data-color="red" data-pts="2">R2</button>
            <button class="ms-btn ms-btn-red" data-color="red" data-pts="3">T3</button>
            <button class="ms-btn ms-btn-red" data-color="red" data-pts="2">N2</button>
            <button class="ms-btn ms-btn-red" data-color="red" data-pts="3">N3</button>
            <button class="ms-btn ms-btn-red" data-color="red" data-pts="4">N4</button>
          </div>
        </div>
        <!-- GREEN -->
        <div>
          <div style="font-size:13px;margin-bottom:4px;">Green Wrestler</div>
          <div class="ms-scoring-grid">
            <button class="ms-btn ms-btn-green" data-color="green" data-pts="1">E1</button>
            <button class="ms-btn ms-btn-green" data-color="green" data-pts="2">R2</button>
            <button class="ms-btn ms-btn-green" data-color="green" data-pts="3">T3</button>
            <button class="ms-btn ms-btn-green" data-color="green" data-pts="2">N2</button>
            <button class="ms-btn ms-btn-green" data-color="green" data-pts="3">N3</button>
            <button class="ms-btn ms-btn-green" data-color="green" data-pts="4">N4</button>
          </div>
        </div>
      </div>

      <div class="ms-row" style="margin-top:12px;">
        <button id="subRed" class="ms-btn ms-btn-gray">-1 Red</button>
        <button id="resetScores" class="ms-btn ms-btn-gold">Reset Scores</button>
        <button id="subGreen" class="ms-btn ms-btn-gray">-1 Green</button>
      </div>
    </section>
  </main>

  <!-- LEFT DRAWER: TIMER SETTINGS -->
  <div id="drawerLeftBackdrop" class="ms-drawer-backdrop"></div>
  <aside id="drawerLeft" class="ms-drawer">
    <div class="ms-drawer-header">
      <div class="ms-drawer-title">Timer Settings</div>
      <button id="closeLeft" class="ms-btn ms-btn-gray">✕</button>
    </div>
    <div class="ms-drawer-body">
      <div class="ms-drawer-section">
        <strong>Regulation Presets</strong>
        <div class="ms-row" style="margin-top:6px;">
          <button class="ms-btn ms-btn-gray" data-preset="60">1:00</button>
          <button class="ms-btn ms-btn-gray" data-preset="90">1:30</button>
          <button class="ms-btn ms-btn-gray" data-preset="120">2:00</button>
        </div>
        <div class="ms-drawer-note">
          Applies to current segment and resets remaining time.
        </div>
      </div>

      <div class="ms-drawer-section">
        <strong>Custom Time</strong>
        <input id="customTimeInput" type="text" placeholder="MM:SS or seconds" />
        <button id="applyCustomTime" class="ms-btn ms-btn-blue" style="margin-top:8px;width:100%;">
          Apply Custom Time
        </button>
        <div class="ms-drawer-note">
          Examples: <code>1:15</code> or <code>75</code>.
        </div>
      </div>
    </div>
  </aside>

  <!-- RIGHT DRAWER: MATCH SETTINGS -->
  <div id="drawerRightBackdrop" class="ms-drawer-backdrop"></div>
  <aside id="drawerRight" class="ms-drawer">
    <div class="ms-drawer-header">
      <div class="ms-drawer-title">Match Settings</div>
      <button id="closeRight" class="ms-btn ms-btn-gray">✕</button>
    </div>
    <div class="ms-drawer-body">
      <div class="ms-drawer-section">
        <strong>Wrestler Names</strong>
        <div style="margin-top:6px;font-size:12px;">Red Wrestler</div>
        <input id="redNameInput" type="text" placeholder="Red wrestler name" />
        <div style="margin-top:8px;font-size:12px;">Green Wrestler</div>
        <input id="greenNameInput" type="text" placeholder="Green wrestler name" />
        <div class="ms-drawer-note">
          Names are stored locally per mat on this device.
        </div>
      </div>

      <div class="ms-drawer-section">
        <strong>Reset Mat</strong>
        <button id="resetMatBtn" class="ms-btn ms-btn-gold" style="width:100%;">
          Reset Entire Mat
        </button>
        <div class="ms-drawer-note">
          Resets scores, time, segment, and clears local names & timeline.
        </div>
      </div>

      <div class="ms-drawer-section">
        <strong>Match Timeline</strong>
        <div id="timelineBox"></div>
      </div>
    </div>
  </aside>

  <!-- MATCH END MODAL (existing match-end.js expects these IDs) -->
  <div id="matchModalBackdrop" class="ms-modal-backdrop"></div>
  <div id="matchModal" class="ms-modal">
    <div class="ms-modal-card">
      <div class="ms-modal-header">
        <div class="ms-modal-title">End Match</div>
      </div>
      <div style="font-size:13px;opacity:0.8;margin-bottom:10px;">
        Select the winning wrestler and the victory type.
      </div>

      <div style="margin-bottom:6px;font-weight:600;font-size:13px;">Winner</div>
      <div class="ms-pill-row">
        <button id="endRed" class="ms-pill-btn">Red Wrestler</button>
        <button id="endGreen" class="ms-pill-btn">Green Wrestler</button>
      </div>

      <div style="margin-bottom:6px;font-weight:600;font-size:13px;">Victory Method</div>
      <div class="ms-pill-row">
        <button class="ms-pill-btn" data-victory="decision">Decision</button>
        <button class="ms-pill-btn" data-victory="tech">Tech Fall</button>
        <button class="ms-pill-btn" data-victory="pin">Pin</button>
        <button class="ms-pill-btn" data-victory="ff">Forfeit</button>
      </div>

      <div class="ms-row" style="justify-content:flex-end;margin-top:10px;">
        <button id="closeMatchModal" class="ms-btn ms-btn-gray">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Local toast used by existing match-end.js -->
  <div id="lastMatchToast"></div>

  <div id="version-tag">Control v3.0</div>

  <!-- MODULE WIRING -->
  <script type="module">
    import { initControlMain } from "./modules/control/control-main.js";
    import { initMatchEnd } from "./modules/control/match-end.js";
    import { initResetMat } from "./modules/control/reset-mat.js";
    import { initRightDrawer } from "./modules/control/right-drawer.js";
    import { initTimeDrawer } from "./modules/control/time-drawer.js";
    import { initNames } from "./modules/control/names.js";
    import { initHeartbeat } from "./modules/control/heartbeat.js";
    import { initDiagnostics } from "./modules/control/diagnostics.js";
    import { initTimeline } from "./modules/timeline/timeline.js";
    import { initSkinClient } from "./modules/ui/skins.js";

    const SERVER_URL = "https://scoreboard-server-er33.onrender.com";

    // Default skin = dark-pro if nothing chosen yet
    if (!localStorage.getItem("matside-skin")) {
      localStorage.setItem("matside-skin", "dark-pro");
    }

    // Skin socket (separate from control socket)
    const skinSocket = io(SERVER_URL, { transports: ["websocket"] });
    initSkinClient(skinSocket);

    // Initialize main control logic
    const ctx = initControlMain({
      serverUrl: SERVER_URL,
      onStateUpdate: null,
      modules: {}
    });

    // Init helpers using ctx
    initMatchEnd(ctx);
    initResetMat(ctx);
    initRightDrawer(ctx);
    initTimeDrawer(ctx);
    initNames(ctx);
    initHeartbeat(ctx);
    initDiagnostics(ctx);

    // Timeline renderer inside right drawer
    const timeline = initTimeline("timelineBox");
    // Expose so ctx.appendTimeline (from right-drawer) can call timeline.render if needed
    ctx.timeline = timeline;

    // Left drawer simple open/close
    const drawerLeft = document.getElementById("drawerLeft");
    const drawerLeftBackdrop = document.getElementById("drawerLeftBackdrop");
    const openLeftBtn = document.getElementById("openLeft");
    const closeLeftBtn = document.getElementById("closeLeft");

    function openLeftDrawer() {
      drawerLeft?.classList.add("open");
      drawerLeftBackdrop?.classList.add("open");
    }
    function closeLeftDrawer() {
      drawerLeft?.classList.remove("open");
      drawerLeftBackdrop?.classList.remove("open");
    }

    openLeftBtn?.addEventListener("click", openLeftDrawer);
    closeLeftBtn?.addEventListener("click", closeLeftDrawer);
    drawerLeftBackdrop?.addEventListener("click", closeLeftDrawer);

    // Expose for debugging if needed
    window.matsideControlCtx = ctx;
  </script>
</body>
</html>
