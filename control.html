<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Matside — Control Panel (v2.18.1)</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  :root{
    --bg:#000;
    --panel:#101114;
    --border:#262626;
    --muted:#bfbfbf;
    --accent:#1e88e5;
    --red:#c6463c;
    --green:#62c96b;
    --gold:#fbc02d;
    --radius:14px;
    --gap:12px;
  }
  *{box-sizing:border-box;}
  html,body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:#fff;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }

  /* HEADER */
  .header-bar{
    background:#000;
    border-bottom:1px solid var(--border);
  }
  .header-inner{
    max-width:1100px;
    margin:0 auto;
    padding:6px 14px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .brand-logo{
    height:42px;
    border-radius:8px;
  }
  .brand-title{
    font-size:18px;
    font-weight:700;
    letter-spacing:0.03em;
  }

  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:14px 16px 22px;
  }

  select{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid var(--border);
    background:#060708;
    color:#fff;
    font-size:14px;
  }

  .icon-btn{
    height:38px;
    width:38px;
    border-radius:50%;
    border:1px solid var(--border);
    background:#060708;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-size:18px;
    transition:background .15s,border-color .15s,transform .1s;
  }
  .icon-btn:hover{
    background:#101114;
    border-color:#3a3a3a;
    transform:translateY(-1px);
  }

  .status{
    color:var(--muted);
    font-size:13px;
  }

  /* SUMMARY BAR */
  .summary{
    margin-top:10px;
    padding:10px 12px;
    border-radius:16px;
    display:flex;
    flex-wrap:wrap;
    gap:10px 18px;
    justify-content:space-between;
    background:#050607;
    border:1px solid var(--border);
    box-shadow:0 8px 20px rgba(0,0,0,0.8);
    font-size:14px;
  }
  .summary strong{font-weight:800;}
  .redText{color:var(--red);}
  .greenText{color:var(--green);}

  /* TIMER PULSE */
  @keyframes timerPulse{
    0%{opacity:1;}
    50%{opacity:.55;}
    100%{opacity:1;}
  }
  .timer-running{
    animation:timerPulse 1.2s infinite ease-in-out;
  }

  /* GRID */
  .grid{
    display:grid;
    grid-template-columns:2fr 3fr;
    gap:var(--gap);
    margin-top:14px;
  }
  @media(max-width:900px){
    .grid{grid-template-columns:1fr;}
  }

  .card{
    background:var(--panel);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:0 10px 26px rgba(0,0,0,0.9);
    border:1px solid var(--border);
  }
  .card h3{
    margin:0 0 10px 0;
    font-size:15px;
    text-transform:uppercase;
    letter-spacing:0.06em;
    color:var(--muted);
  }

  button{
    border:0;
    border-radius:999px;
    padding:10px 14px;
    font-weight:700;
    cursor:pointer;
    font-size:15px;
    transition:background .15s,transform .1s,box-shadow .15s;
  }
  button:active{
    transform:translateY(1px);
    box-shadow:none;
  }
  .small{padding:8px 11px;font-size:13px;}
  .btn-wide{min-width:120px;}

  .blue{
    background:var(--accent);
    color:#fff;
    box-shadow:0 4px 14px rgba(30,136,229,0.45);
  }
  .gray{background:#2c2f32;color:#fff;}
  .red{
    background:var(--red);
    color:#fff;
    box-shadow:0 4px 14px rgba(198,70,60,0.65);
  }
  .green{
    background:var(--green);
    color:#000;
    box-shadow:0 4px 14px rgba(98,201,107,0.55);
  }
  .gold{background:var(--gold);color:#000;}

  .row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  /* SCORING GRID */
  .score-columns{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  @media(max-width:600px){
    .score-columns{grid-template-columns:1fr;}
  }
  .scoring-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:8px;
  }
  @media(max-width:450px){
    .scoring-grid{grid-template-columns:repeat(2,1fr);}
  }

  /* DRAWERS */
  .drawer-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    opacity:0;
    pointer-events:none;
    transition:opacity .18s;
    z-index:9000;
  }
  .drawer-backdrop.open{
    opacity:1;
    pointer-events:auto;
  }

  .drawer-panel{
    position:fixed;
    top:0;
    height:100%;
    width:380px;
    max-width:80vw;
    background:#050608;
    border-left:1px solid var(--border);
    border-right:1px solid var(--border);
    z-index:9001;
    display:flex;
    flex-direction:column;
    box-shadow:0 0 40px rgba(0,0,0,0.95);
    transform:translateX(100%);
    transition:transform .2s ease-out;
  }
  #drawerLeft.drawer-panel{
    left:0;
    border-right:1px solid var(--border);
    border-left:none;
    transform:translateX(-100%);
  }
  #drawerLeft.drawer-panel.open{transform:translateX(0);}
  #drawerRight.drawer-panel{
    right:0;
  }
  #drawerRight.drawer-panel.open{transform:translateX(0);}

  .drawer-header{
    padding:12px 14px 10px;
    border-bottom:1px solid var(--border);
    background:#08090b;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .drawer-title{
    font-size:13px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.06em;
    color:var(--muted);
    position:relative;
    padding-bottom:4px;
  }
  .drawer-title::after{
    content:"";
    position:absolute;
    left:0;
    bottom:0;
    width:32px;
    height:2px;
    border-radius:2px;
    background:var(--accent);
  }
  .drawer-close-btn{
    border:0;
    background:transparent;
    color:#fff;
    font-size:18px;
    cursor:pointer;
  }
  .drawer-body{
    padding:12px 14px 16px;
    font-size:13px;
    overflow-y:auto;
  }
  .drawer-section{margin-bottom:18px;}
  .drawer-section h4{
    margin:0 0 6px 0;
    font-size:12px;
    text-transform:uppercase;
    color:var(--muted);
    letter-spacing:0.06em;
  }
  .drawer-note{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
  }
  input[type=text]{
    width:100%;
    padding:8px 9px;
    border-radius:8px;
    border:1px solid var(--border);
    background:#050608;
    color:#fff;
    font-size:13px;
  }

  /* TIMELINE */
  .timeline-list{
    max-height:260px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .timeline-item{
    background:#0c0e12;
    border-radius:8px;
    padding:6px 8px;
    font-size:12px;
    border:1px solid #181a1f;
  }
  .timeline-main{font-weight:600;}
  .timeline-meta{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }

  /* END MATCH MODAL */
  #endMatchModal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100000;
  }
  #endMatchModal.open{display:flex;}
  .modal-panel{
    background:#050608;
    padding:22px 18px 18px;
    border-radius:16px;
    width:90%;
    max-width:380px;
    text-align:center;
    border:1px solid var(--border);
    box-shadow:0 10px 32px rgba(0,0,0,0.9);
    position:relative;
  }
  .modal-panel h2{
    margin:0 0 10px;
    font-size:18px;
  }
  .modal-sub{
    font-size:13px;
    color:var(--muted);
    margin-bottom:12px;
  }
  .modal-btn-row{
    display:flex;
    gap:10px;
    margin-bottom:10px;
    flex-wrap:wrap;
    justify-content:center;
  }
  .modal-btn{
    border-radius:999px;
    padding:8px 14px;
    font-size:14px;
    border:0;
    cursor:pointer;
    font-weight:700;
  }
  .modal-red{background:var(--red);color:#fff;}
  .modal-green{background:var(--green);color:#000;}
  .modal-gold{background:var(--gold);color:#000;}
  .modal-blue{background:var(--accent);color:#fff;}
  .modal-selected{box-shadow:0 0 0 2px #fff;}
  .modal-close-btn{
    position:absolute;
    top:8px;
    right:10px;
    background:transparent;
    border:0;
    color:#888;
    font-size:16px;
    cursor:pointer;
  }
  .modal-summary{
    font-size:14px;
    margin-bottom:12px;
  }

  #version-tag{
    position:fixed;
    bottom:6px;
    right:10px;
    font-size:11px;
    color:#666;
    opacity:.75;
    font-weight:600;
  }

  .hidden{display:none !important;}

/* SUBMISSION TOAST */
.submit-toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  padding: 12px 18px;
  border-radius: 12px;
  font-size: 14px;
  border: 1px solid #444;
  box-shadow: 0 6px 20px rgba(0,0,0,0.5);
  z-index: 1000000;
  opacity: 0;
  transition: opacity .25s ease;
}
.submit-toast.show {
  opacity: 1;
}
.hidden { display:none!important; }
  
</style>
</head>
<body>

<div class="header-bar">
  <div class="header-inner">
    <img src="https://www.matside.org/assets/images/image01.png" class="brand-logo" alt="Matside">
    <div class="brand-title">Matside</div>
  </div>
</div>

<div class="wrap">

  <div style="display:flex;justify-content:space-between;align-items:center;">
    <button id="openDrawerLeft" class="icon-btn" title="Timer Settings">⚡</button>

    <div style="display:flex;align-items:center;gap:10px;">
      <label>Mat</label>
      <select id="matSelect">
        <option value="1">Mat 1</option>
        <option value="2">Mat 2</option>
        <option value="3">Mat 3</option>
        <option value="4">Mat 4</option>
      </select>
      <div class="status">Status: <span id="conn">connecting…</span></div>
    </div>

    <button id="openDrawerRight" class="icon-btn" title="Match Settings">⚙️</button>
  </div>

  <div class="summary">
    <div>Mat: <strong id="sumMat">1</strong></div>
    <div>Period: <strong id="sumPeriod">1</strong></div>
    <div>Time: <strong id="sumTime">01:00</strong></div>
    <div>Red: <strong id="sumRed" class="redText">0</strong></div>
    <div>Green: <strong id="sumGreen" class="greenText">0</strong></div>
  </div>

  <div class="grid">

    <div class="card">
      <h3>Timer</h3>
      <div class="row">
        <button id="startBtn" class="blue btn-wide">Start</button>
        <button id="stopBtn" class="gray btn-wide">Stop</button>
        <button id="endMatchBtn" class="gold btn-wide">End Match</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="resetTimerBtn" class="gray btn-wide">Reset Timer</button>
      </div>
    </div>

    <div class="card">
      <h3>Scoring</h3>

      <div class="score-columns">
        <div>
          <div class="status" style="margin-bottom:4px;">Red Wrestler</div>
          <div class="scoring-grid">
            <button class="red small score-btn" data-color="red" data-pts="1" data-code="E1">E1</button>
            <button class="red small score-btn" data-color="red" data-pts="2" data-code="R2">R2</button>
            <button class="red small score-btn" data-color="red" data-pts="3" data-code="T3">T3</button>
            <button class="red small score-btn" data-color="red" data-pts="2" data-code="N2">N2</button>
            <button class="red small score-btn" data-color="red" data-pts="3" data-code="N3">N3</button>
            <button class="red small score-btn" data-color="red" data-pts="4" data-code="N4">N4</button>
          </div>
        </div>

        <div>
          <div class="status" style="margin-bottom:4px;">Green Wrestler</div>
          <div class="scoring-grid">
            <button class="green small score-btn" data-color="green" data-pts="1" data-code="E1">E1</button>
            <button class="green small score-btn" data-color="green" data-pts="2" data-code="R2">R2</button>
            <button class="green small score-btn" data-color="green" data-pts="3" data-code="T3">T3</button>
            <button class="green small score-btn" data-color="green" data-pts="2" data-code="N2">N2</button>
            <button class="green small score-btn" data-color="green" data-pts="3" data-code="N3">N3</button>
            <button class="green small score-btn" data-color="green" data-pts="4" data-code="N4">N4</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="subRed" class="small gray">-1 Red</button>
        <button id="resetScores" class="small gold">Reset Scores</button>
        <button id="subGreen" class="small gray">-1 Green</button>
      </div>
    </div>
  </div>
</div>

<!-- LEFT DRAWER -->
<div id="drawerLeft" class="drawer-panel">
  <div class="drawer-header">
    <div class="drawer-title">Timer Settings</div>
    <button class="drawer-close-btn" id="closeDrawerLeft">✕</button>
  </div>
  <div class="drawer-body">
    <div class="drawer-section">
      <h4>Regulation Presets</h4>
      <div class="row">
        <button class="small gray preset-btn" data-sec="60">1:00</button>
        <button class="small gray preset-btn" data-sec="90">1:30</button>
        <button class="small gray preset-btn" data-sec="120">2:00</button>
      </div>
    </div>
    <div class="drawer-section">
      <h4>Custom Time</h4>
      <input id="customTimeInput" type="text" placeholder="MM:SS or seconds">
      <button id="applyCustomTime" class="small blue" style="margin-top:6px;width:100%;">Apply Custom Time</button>
      <div class="drawer-note">
        Custom time applies to this mat. If the timer is stopped, the new value will appear immediately.
      </div>
    </div>
  </div>
</div>

<!-- RIGHT DRAWER -->
<div id="drawerRight" class="drawer-panel">
  <div class="drawer-header">
    <div class="drawer-title">Match Settings</div>
    <button class="drawer-close-btn" id="closeDrawerRight">✕</button>
  </div>
  <div class="drawer-body">

    <div class="drawer-section">
      <h4>Wrestler Names</h4>
      <label style="font-size:12px;">Red Wrestler</label>
      <input id="redNameInput" type="text" placeholder="Red wrestler name">
      <label style="font-size:12px;margin-top:8px;display:block;">Green Wrestler</label>
      <input id="greenNameInput" type="text" placeholder="Green wrestler name">
      <div class="drawer-note">Names are saved per mat on this device and cleared when you reset the mat.</div>
    </div>

    <div class="drawer-section">
      <h4>Reset Mat</h4>
      <button id="resetMatBtn" class="small red" style="width:100%;">Reset Entire Mat</button>
      <div class="drawer-note">
        Resets time, period, scores, names, and the timeline for the selected mat. Use this between matches.
      </div>
    </div>

    <div class="drawer-section">
      <h4>Match Timeline</h4>
      <div id="timelineList" class="timeline-list"></div>
    </div>
  </div>
</div>

<div id="backdropLeft" class="drawer-backdrop"></div>
<div id="backdropRight" class="drawer-backdrop"></div>

<!-- END MATCH MODAL -->
<div id="endMatchModal">
  <div class="modal-panel">
    <button class="modal-close-btn" id="endMatchClose">✕</button>
    <h2>End Match</h2>
    <div class="modal-sub" id="endMatchSubtitle">Select the winner.</div>

    <div id="endMatchStep1">
      <div class="modal-btn-row">
        <button id="winnerRedBtn"   class="modal-btn modal-red">Red Wrestler</button>
        <button id="winnerGreenBtn" class="modal-btn modal-green">Green Wrestler</button>
      </div>
    </div>

    <div id="endMatchStep2" class="hidden">
      <div class="modal-sub">How did they win?</div>
      <div class="modal-btn-row">
        <button class="modal-btn modal-gold result-btn" data-method="decision">Decision</button>
        <button class="modal-btn modal-gold result-btn" data-method="tech">Tech Fall</button>
        <button class="modal-btn modal-gold result-btn" data-method="pin">Pin</button>
        <button class="modal-btn modal-gold result-btn" data-method="forfeit">Forfeit</button>
      </div>
    </div>

    <div id="endMatchStep3" class="hidden">
      <div class="modal-summary" id="endMatchSummary"></div>
      <div class="modal-btn-row" style="margin-top:10px;">
        <button id="submitMatchBtn" class="modal-btn modal-blue">Submit Result</button>
      </div>
    </div>
  </div>
</div>

<div id="version-tag">v2.18</div>

<script>
const socket = io("https://scoreboard-server-er33.onrender.com", {
  transports:["websocket","polling"]
});

let lastState = null;
const periodLengthByMat = {1:60,2:60,3:60,4:60};
const timeline = {1:[],2:[],3:[],4:[]};
const lastZeroSignature = {1:null,2:null,3:null,4:null};

function currentMat(){
  return parseInt(document.getElementById("matSelect").value,10) || 1;
}

socket.on("connect", () => {
  document.getElementById("conn").textContent = "connected";
});
socket.on("disconnect", () => {
  document.getElementById("conn").textContent = "disconnected";
});
socket.on("stateUpdate", (state)=>{
  lastState = state;
  updateUI(state);
  maybeHandleEndOfPeriod(state);
});

function fmt(sec){
  sec = Math.max(0, sec || 0);
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function updateUI(state){
  const mat = currentMat();
  const m = state.mats?.[mat];
  if(!m) return;

  document.getElementById("sumMat").textContent = mat;
  document.getElementById("sumPeriod").textContent = m.period ?? 1;
  document.getElementById("sumTime").textContent = fmt(m.time ?? 0);
  document.getElementById("sumRed").textContent = m.red ?? 0;
  document.getElementById("sumGreen").textContent = m.green ?? 0;

  const timeEl = document.getElementById("sumTime");
  if(m.running) timeEl.classList.add("timer-running");
  else timeEl.classList.remove("timer-running");
}

/* OVERTIME & PERIOD PROGRESSION */
function maybeHandleEndOfPeriod(state){
  const mat = currentMat();
  const m = state.mats?.[mat];
  if(!m) return;

  if((m.time ?? 0) > 0) return;
  if(m.running) return;

  const red = m.red ?? 0;
  const green = m.green ?? 0;
  const diff = Math.abs(red - green);
  const period = m.period ?? 1;

  const sig = `${period}|${red}|${green}`;
  if(lastZeroSignature[mat] === sig) return;
  lastZeroSignature[mat] = sig;

  const baseReg = periodLengthByMat[mat] || 60;

  if(typeof period === "number"){
    if(period < 3){
      socket.emit("updateState",{
        mat,
        updates:{ period: period + 1, time: baseReg, running:false }
      });
      pushTimeline(mat,{
        label:`End of Period ${period} → Period ${period+1}`,
        timeStr:fmt(m.time||0),period:period,red,green
      });
      return;
    }
    if(period === 3){
      if(diff !== 0){
        pushTimeline(mat,{
          label:`End of 3rd — winner by points (use End Match)`,
          timeStr:fmt(m.time||0),period:3,red,green
        });
        return;
      } else {
        socket.emit("updateState",{
          mat,
          updates:{ period:"OT", time:60, running:false }
        });
        pushTimeline(mat,{
          label:`End of 3rd — going to OT (1:00)`,
          timeStr:fmt(m.time||0),period:3,red,green
        });
        return;
      }
    }
  }

  if(period === "OT"){
    if(diff !== 0){
      pushTimeline(mat,{
        label:`OT ended — sudden victory (use End Match)`,
        timeStr:fmt(m.time||0),period:"OT",red,green
      });
      return;
    } else {
      socket.emit("updateState",{
        mat,
        updates:{ period:"TB1", time:30, running:false }
      });
      pushTimeline(mat,{
        label:`OT tied — going to TB1 (0:30)`,
        timeStr:fmt(m.time||0),period:"OT",red,green
      });
      return;
    }
  }

  if(period === "TB1"){
    socket.emit("updateState",{
      mat,
      updates:{ period:"TB2", time:30, running:false }
    });
    pushTimeline(mat,{
      label:`TB1 ended — going to TB2 (0:30)`,
      timeStr:fmt(m.time||0),period:"TB1",red,green
    });
    return;
  }

  if(period === "TB2"){
    if(diff !== 0){
      pushTimeline(mat,{
        label:`TB2 ended — advantage/winner (use End Match)`,
        timeStr:fmt(m.time||0),period:"TB2",red,green
      });
      return;
    } else {
      socket.emit("updateState",{
        mat,
        updates:{ period:"UT", time:30, running:false }
      });
      pushTimeline(mat,{
        label:`TB2 tied — going to UT (0:30)`,
        timeStr:fmt(m.time||0),period:"TB2",red,green
      });
      return;
    }
  }

  if(period === "UT"){
    pushTimeline(mat,{
      label:`UT ended — choose winner manually (End Match)`,
      timeStr:fmt(m.time||0),period:"UT",red,green
    });
    return;
  }
}

function pushTimeline(mat,entry){
  if(!timeline[mat]) timeline[mat]=[];
  timeline[mat].push(entry);
  if(timeline[mat].length>200) timeline[mat].shift();
  renderTimeline(mat);
}

function renderTimeline(mat){
  const list = document.getElementById("timelineList");
  if(!list) return;
  list.innerHTML="";
  const events = timeline[mat] || [];
  events.slice().reverse().forEach(ev=>{
    const div = document.createElement("div");
    div.className="timeline-item";
    div.innerHTML = `
      <div class="timeline-main">${ev.label}</div>
      <div class="timeline-meta">
        ${ev.timeStr} · Period ${ev.period} · Red ${ev.red} – Green ${ev.green}
      </div>
    `;
    list.appendChild(div);
  });
}

/* NAMES (local per mat) */
const redNameInput = document.getElementById("redNameInput");
const greenNameInput = document.getElementById("greenNameInput");

function loadNamesForMat(mat){
  const store = JSON.parse(localStorage.getItem("matside_names") || "{}");
  const data = store[mat] || {};
  redNameInput.value = data.red || "";
  greenNameInput.value = data.green || "";
}
function saveNamesForMat(mat){
  const store = JSON.parse(localStorage.getItem("matside_names") || "{}");
  store[mat] = {
    red: redNameInput.value.trim(),
    green: greenNameInput.value.trim()
  };
  localStorage.setItem("matside_names", JSON.stringify(store));
}
function clearNamesForMat(mat){
  const store = JSON.parse(localStorage.getItem("matside_names") || "{}");
  delete store[mat];
  localStorage.setItem("matside_names", JSON.stringify(store));
  redNameInput.value="";
  greenNameInput.value="";
}
redNameInput.addEventListener("input",()=>saveNamesForMat(currentMat()));
greenNameInput.addEventListener("input",()=>saveNamesForMat(currentMat()));

/* MAT CHANGE */
document.getElementById("matSelect").addEventListener("change",()=>{
  const mat=currentMat();
  loadNamesForMat(mat);
  if(lastState) updateUI(lastState);
  renderTimeline(mat);
});
loadNamesForMat(currentMat());

/* TIMER CONTROLS */
document.getElementById("startBtn").onclick=()=>{
  const mat=currentMat();
  socket.emit("updateState",{mat,updates:{running:true}});
};
document.getElementById("stopBtn").onclick=()=>{
  const mat=currentMat();
  socket.emit("updateState",{mat,updates:{running:false}});
};
document.getElementById("resetTimerBtn").onclick=()=>{
  const mat=currentMat();
  const base=periodLengthByMat[mat]||60;
  socket.emit("updateState",{mat,updates:{time:base,running:false}});
};

/* PRESETS & CUSTOM TIME */
document.querySelectorAll(".preset-btn").forEach(btn=>{
  btn.onclick=()=>{
    const sec=parseInt(btn.dataset.sec,10);
    if(!sec) return;
    const mat=currentMat();
    periodLengthByMat[mat]=sec;
    const m=lastState?.mats?.[mat];
    if(m && !m.running){
      socket.emit("updateState",{mat,updates:{time:sec}});
    }
  };
});
document.getElementById("applyCustomTime").onclick=()=>{
  const raw=document.getElementById("customTimeInput").value.trim();
  if(!raw) return;
  let sec=0;
  if(raw.includes(":")){
    const [mm,ss]=raw.split(":");
    sec=(parseInt(mm,10)||0)*60 + (parseInt(ss,10)||0);
  }else{
    sec=parseInt(raw,10)||0;
  }
  if(sec<=0) return;
  const mat=currentMat();
  periodLengthByMat[mat]=sec;
  const m=lastState?.mats?.[mat];
  if(m && !m.running){
    socket.emit("updateState",{mat,updates:{time:sec}});
  }
  document.getElementById("customTimeInput").value="";
};

/* SCORING */
document.querySelectorAll(".score-btn").forEach(btn=>{
  btn.onclick=()=>{
    const mat=currentMat();
    const color=btn.dataset.color;
    const pts=parseInt(btn.dataset.pts,10);
    const code=btn.dataset.code;
    const m=lastState?.mats?.[mat] || {red:0,green:0,time:0,period:1};

    socket.emit("addPoints",{mat,color,pts});

    const newRed = color==="red" ? (m.red||0)+pts : (m.red||0);
    const newGreen = color==="green" ? (m.green||0)+pts : (m.green||0);

    pushTimeline(mat,{
      label:`${color.toUpperCase()} +${pts} (${code})`,
      timeStr:fmt(m.time||0),
      period:m.period||1,
      red:newRed,
      green:newGreen
    });
  };
});

document.getElementById("subRed").onclick=()=>{
  const mat=currentMat();
  const m=lastState?.mats?.[mat] || {red:0,green:0,time:0,period:1};
  socket.emit("subPoint",{mat,color:"red"});
  pushTimeline(mat,{
    label:"RED -1 (correction)",
    timeStr:fmt(m.time||0),
    period:m.period||1,
    red:Math.max(0,(m.red||0)-1),
    green:m.green||0
  });
};
document.getElementById("subGreen").onclick=()=>{
  const mat=currentMat();
  const m=lastState?.mats?.[mat] || {red:0,green:0,time:0,period:1};
  socket.emit("subPoint",{mat,color:"green"});
  pushTimeline(mat,{
    label:"GREEN -1 (correction)",
    timeStr:fmt(m.time||0),
    period:m.period||1,
    red:m.red||0,
    green:Math.max(0,(m.green||0)-1)
  });
};
document.getElementById("resetScores").onclick=()=>{
  const mat=currentMat();
  const m=lastState?.mats?.[mat] || {red:0,green:0,time:0,period:1};
  socket.emit("updateState",{mat,updates:{red:0,green:0}});
  pushTimeline(mat,{
    label:"Scores reset",
    timeStr:fmt(m.time||0),
    period:m.period||1,
    red:0,
    green:0
  });
};

/* FULL MAT RESET */
function doFullMatReset(mat,{clearTimeline,clearNames}){
  if(clearTimeline){
    timeline[mat]=[];
    renderTimeline(mat);
  }
  if(clearNames){
    clearNamesForMat(mat);
  }
  const base=periodLengthByMat[mat]||60;
  socket.emit("updateState",{
    mat,
    updates:{
      period:1,
      time:base,
      running:false,
      red:0,
      green:0
    }
  });
}
document.getElementById("resetMatBtn").onclick=()=>{
  const mat=currentMat();
  doFullMatReset(mat,{clearTimeline:true,clearNames:true});
};

/* END MATCH MODAL */
const endMatchModal=document.getElementById("endMatchModal");
const endMatchSubtitle=document.getElementById("endMatchSubtitle");
const step1=document.getElementById("endMatchStep1");
const step2=document.getElementById("endMatchStep2");
const step3=document.getElementById("endMatchStep3");
const winnerRedBtn=document.getElementById("winnerRedBtn");
const winnerGreenBtn=document.getElementById("winnerGreenBtn");
const resultButtons=document.querySelectorAll(".result-btn");
const endMatchSummary=document.getElementById("endMatchSummary");
const submitMatchBtn=document.getElementById("submitMatchBtn");
const endMatchClose=document.getElementById("endMatchClose");

let chosenWinner=null;
let chosenMethod=null;
let modalMat=null;

function openEndMatchModal(){
  const mat=currentMat();
  const m=lastState?.mats?.[mat];
  if(!m){
    alert("No mat state yet.");
    return;
  }
  modalMat=mat;
  chosenWinner=null;
  chosenMethod=null;

  winnerRedBtn.textContent = redNameInput.value.trim() || "Red Wrestler";
  winnerGreenBtn.textContent = greenNameInput.value.trim() || "Green Wrestler";

  winnerRedBtn.classList.remove("modal-selected");
  winnerGreenBtn.classList.remove("modal-selected");
  resultButtons.forEach(b=>b.classList.remove("modal-selected"));

  const diff=(m.red||0)-(m.green||0);
  if(diff>0) winnerRedBtn.classList.add("modal-selected");
  else if(diff<0) winnerGreenBtn.classList.add("modal-selected");

  step1.classList.remove("hidden");
  step2.classList.add("hidden");
  step3.classList.add("hidden");
  endMatchSubtitle.textContent="Select the winner.";
  endMatchModal.classList.add("open");
}
function closeEndMatchModal(){
  endMatchModal.classList.remove("open");
}
document.getElementById("endMatchBtn").onclick=openEndMatchModal;
endMatchClose.onclick=closeEndMatchModal;
endMatchModal.addEventListener("click",(e)=>{
  if(e.target===endMatchModal) closeEndMatchModal();
});

winnerRedBtn.onclick=()=>{
  chosenWinner="red";
  winnerRedBtn.classList.add("modal-selected");
  winnerGreenBtn.classList.remove("modal-selected");
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
  endMatchSubtitle.textContent="How did they win?";
};
winnerGreenBtn.onclick=()=>{
  chosenWinner="green";
  winnerGreenBtn.classList.add("modal-selected");
  winnerRedBtn.classList.remove("modal-selected");
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
  endMatchSubtitle.textContent="How did they win?";
};

resultButtons.forEach(btn=>{
  btn.onclick=()=>{
    if(!chosenWinner) return;
    chosenMethod=btn.dataset.method;
    resultButtons.forEach(b=>b.classList.remove("modal-selected"));
    btn.classList.add("modal-selected");

    const mat=modalMat;
    const m=lastState?.mats?.[mat];
    if(!m) return;

    const redScore=m.red||0;
    const greenScore=m.green||0;

    const winnerName = chosenWinner==="red"
      ? (redNameInput.value.trim() || "Red Wrestler")
      : (greenNameInput.value.trim() || "Green Wrestler");

    const methodLabel={
      decision:"Decision",
      tech:"Tech Fall",
      pin:"Pin",
      forfeit:"Forfeit"
    }[chosenMethod] || chosenMethod;

    endMatchSummary.textContent=
      `Winner: ${winnerName} (${methodLabel}) — Final score ${redScore}–${greenScore}.`;

    step2.classList.add("hidden");
    step3.classList.remove("hidden");
    endMatchSubtitle.textContent="Confirm result and submit.";
  };
});

submitMatchBtn.onclick=()=>{
  const mat=modalMat;
  const m=lastState?.mats?.[mat];
  if(!m || !chosenWinner || !chosenMethod) return;

  const redScore=m.red||0;
  const greenScore=m.green||0;

  const resultPayload={
    mat,
    winner:chosenWinner,
    method:chosenMethod,
    redScore,
    greenScore,
    period:m.period || 1,
    redName:redNameInput.value.trim() || null,
    greenName:greenNameInput.value.trim() || null,
    timestamp:new Date().toISOString()
  };

  socket.emit("matchEnded", resultPayload, (serverResponse)=>{
  // server acknowledges the save
  if(serverResponse && serverResponse.ok){
    socket.emit("matchLogged", {
      ...resultPayload,
      winnerName: resultPayload.winner === "red"
          ? (redNameInput.value.trim() || "Red Wrestler")
          : (greenNameInput.value.trim() || "Green Wrestler"),
      methodLabel:{
        decision:"Decision",tech:"Tech Fall",pin:"Pin",forfeit:"Forfeit"
      }[resultPayload.method],
    });
  }
});

  pushTimeline(mat,{
    label:`Match Ended — Winner: ${chosenWinner.toUpperCase()} (${{
      decision:"Decision",tech:"Tech Fall",pin:"Pin",forfeit:"Forfeit"
    }[chosenMethod] || chosenMethod})`,
    timeStr:fmt(m.time||0),
    period:m.period||1,
    red:redScore,
    green:greenScore
  });

  doFullMatReset(mat,{clearTimeline:false,clearNames:false});
  closeEndMatchModal();
};

/* DRAWERS */
const drawerLeft=document.getElementById("drawerLeft");
const drawerRight=document.getElementById("drawerRight");
const backdropLeft=document.getElementById("backdropLeft");
const backdropRight=document.getElementById("backdropRight");

document.getElementById("openDrawerLeft").onclick=()=>{
  drawerLeft.classList.add("open");
  backdropLeft.classList.add("open");
};
document.getElementById("openDrawerRight").onclick=()=>{
  drawerRight.classList.add("open");
  backdropRight.classList.add("open");
};

document.getElementById("closeDrawerLeft").onclick=()=>{
  drawerLeft.classList.remove("open");
  backdropLeft.classList.remove("open");
};
document.getElementById("closeDrawerRight").onclick=()=>{
  drawerRight.classList.remove("open");
  backdropRight.classList.remove("open");
};

backdropLeft.onclick=()=>{
  drawerLeft.classList.remove("open");
  backdropLeft.classList.remove("open");
};
backdropRight.onclick=()=>{
  drawerRight.classList.remove("open");
  backdropRight.classList.remove("open");
};

/* MATCH LOG CONFIRMATION */
socket.on("matchLogged", (data) => {
  showSubmissionToast(data);
  updateRecentSubmission(data);
});

/* Toast function */
function showSubmissionToast(data){
  const toast = document.getElementById("submitToast");
  const text = document.getElementById("submitToastText");

  text.textContent = `Submitted: ${data.winnerName} (${data.methodLabel})`;
  toast.classList.remove("hidden");

  // Fade-in
  toast.classList.add("show");

  // Hide after 5 seconds
  setTimeout(()=>{
    toast.classList.remove("show");
    setTimeout(()=>toast.classList.add("hidden"), 250);
  }, 5000);
}

/* Recent submission box */
function updateRecentSubmission(data){
  const box = document.getElementById("recentSubmissionBox");

  box.innerHTML = `
    <div><strong>${data.winnerName}</strong> (${data.methodLabel})</div>
    <div>Final: Red ${data.redScore} — Green ${data.greenScore}</div>
    <div style="color:#777;margin-top:4px;font-size:11px;">
      Mat ${data.mat} · ${new Date(data.timestamp).toLocaleTimeString()}
    </div>
  `;
}

  /* MATCH LOG CONFIRMATION */
socket.on("matchLogged", (data) => {
  showSubmissionToast(data);
  updateRecentSubmission(data);
});

/* Toast function */
function showSubmissionToast(data){
  const toast = document.getElementById("submitToast");
  const text = document.getElementById("submitToastText");

  text.textContent = `Submitted: ${data.winnerName} (${data.methodLabel})`;
  toast.classList.remove("hidden");

  // Fade-in
  toast.classList.add("show");

  // Hide after 5 seconds
  setTimeout(()=>{
    toast.classList.remove("show");
    setTimeout(()=>toast.classList.add("hidden"), 250);
  }, 5000);
}

/* Recent submission box */
function updateRecentSubmission(data){
  const box = document.getElementById("recentSubmissionBox");

  box.innerHTML = `
    <div><strong>${data.winnerName}</strong> (${data.methodLabel})</div>
    <div>Final: Red ${data.redScore} — Green ${data.greenScore}</div>
    <div style="color:#777;margin-top:4px;font-size:11px;">
      Mat ${data.mat} · ${new Date(data.timestamp).toLocaleTimeString()}
    </div>
  `;
}
  
</script>

<!-- SUBMISSION TOAST -->
<div id="submitToast" class="submit-toast hidden">
  <div id="submitToastText">Match Submitted</div>
</div>
  
</body>
</html>
