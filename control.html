<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Matside — Control Panel v4.0 (Monolithic)</title>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  :root{
    --bg:#070809;
    --panel:#15161a;
    --border:#232632;
    --muted:#9aa0a6;
    --accent:#1e88e5;
    --red:#d32f2f;
    --green:#00c853;
    --gold:#fbc02d;
    --radius:12px;
    --gap:14px;
  }

  *{ box-sizing:border-box; }

  html,body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:#fff;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }

  body{
    min-height:100vh;
  }

  /* Header */
  .header-bar{
    background:#070809;
    border-bottom:1px solid #111215;
  }
  .header-inner{
    max-width:1200px;
    margin:0 auto;
    padding:6px 16px;
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand-logo{
    height:42px;
    border-radius:8px;
  }
  .brand-title{
    font-size:18px;
    font-weight:700;
  }

  .wrap{
    max-width:1200px;
    margin:0 auto;
    padding:16px;
  }

  /* Top bar */
  .top-bar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    margin-bottom:10px;
  }
  .brand-mini{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .brand-mini img{
    height:22px;
    border-radius:6px;
  }
  .brand-mini-title{
    font-size:14px;
    font-weight:600;
    color:var(--muted);
  }

  select{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #2c2f3a;
    background:#0e1012;
    color:#fff;
  }

  .status{
    font-size:12px;
    color:var(--muted);
  }

  /* Summary bar */
  .summary{
    margin-top:8px;
    padding:10px 14px;
    border-radius:16px;
    background:linear-gradient(135deg,#15171c,#0b0d13);
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 12px 28px rgba(0,0,0,.8);
    border:1px solid #20232d;
  }
  .summary strong{
    font-weight:800;
  }
  .redText{ color:var(--red); }
  .greenText{ color:var(--green); }

  /* Flashing timer when running */
  @keyframes timerPulse{
    0%{opacity:1;}
    50%{opacity:.55;}
    100%{opacity:1;}
  }
  .timer-running{
    animation:timerPulse 1.1s ease-in-out infinite;
  }

  /* Grid layout */
  .grid{
    display:grid;
    grid-template-columns:1.2fr 1fr;
    gap:var(--gap);
    margin-top:14px;
  }
  @media(max-width:900px){
    .grid{
      grid-template-columns:1fr;
    }
  }

  .card{
    background:var(--panel);
    border-radius:var(--radius);
    padding:14px;
    border:1px solid var(--border);
    box-shadow:0 8px 22px rgba(0,0,0,.7);
  }
  .card h3{
    margin:0 0 10px 0;
    font-size:15px;
    text-transform:uppercase;
    letter-spacing:0.08em;
    color:var(--muted);
  }

  /* Buttons */
  button{
    border:0;
    border-radius:10px;
    padding:9px 12px;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
  }
  .btn-wide{
    width:100%;
  }
  .small{
    padding:7px 10px;
    font-size:13px;
  }

  .blue{ background:var(--accent); color:#fff; }
  .gray{ background:#2a2b2c; color:#fff; }
  .red{ background:var(--red); color:#fff; }
  .green{ background:var(--green); color:#fff; }
  .gold{ background:var(--gold); color:#000; }

  .row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  /* Timer card */
  .timer-layout{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .timer-btn-row{
    display:flex;
    gap:8px;
  }

  /* Scoring */
  .score-columns{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }
  @media(max-width:600px){
    .score-columns{ grid-template-columns:1fr; }
  }
  .scoring-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:8px;
  }
  @media(max-width:450px){
    .scoring-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  }

  /* Names card */
  .names-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  @media(max-width:700px){
    .names-grid{
      grid-template-columns:1fr;
    }
  }
  .input-label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .text-input{
    width:100%;
    padding:8px 9px;
    border-radius:8px;
    border:1px solid #282c35;
    background:#0e1013;
    color:#fff;
    font-size:13px;
  }

  /* Right column cards */
  .pill-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .pill-btn{
    padding:5px 9px;
    font-size:12px;
    border-radius:999px;
    background:#262a32;
    color:#fff;
    border:1px solid transparent;
    cursor:pointer;
  }
  .pill-btn.active{
    border-color:var(--accent);
    background:#1b2330;
  }
  .hint{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
  }

  /* Custom time */
  .custom-time-row{
    display:flex;
    gap:8px;
  }
  .custom-time-row input{
    flex:1;
  }

  /* Timeline */
  #timelineBox{
    max-height:260px;
    overflow-y:auto;
    background:#0b0c0f;
    border-radius:10px;
    padding:8px;
    border:1px solid #202127;
    font-size:12px;
  }
  .timeline-item{
    padding:4px 0;
    border-bottom:1px solid rgba(255,255,255,0.04);
  }
  .timeline-item:last-child{
    border-bottom:none;
  }
  .timeline-meta{
    color:var(--muted);
    font-size:10px;
  }

  /* Toast */
  #toast{
    position:fixed;
    left:50%;
    bottom:10px;
    transform:translateX(-50%);
    background:var(--accent);
    color:#fff;
    padding:8px 12px;
    border-radius:999px;
    font-size:13px;
    font-weight:600;
    display:none;
    align-items:center;
    gap:6px;
    box-shadow:0 8px 22px rgba(0,0,0,.7);
    z-index:9999;
  }

  /* Match modal */
  #matchModalBackdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9998;
  }
  #matchModalBackdrop.open{
    display:flex;
  }
  .modal{
    background:#15171c;
    border-radius:14px;
    padding:14px 16px 16px;
    width:300px;
    border:1px solid #2a2f38;
    box-shadow:0 20px 40px rgba(0,0,0,.9);
    font-size:13px;
  }
  .modal h3{
    margin:0 0 6px 0;
    font-size:15px;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .modal-section{
    margin-top:10px;
  }
  .modal-section h4{
    margin:0 0 4px 0;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
  }
  .suggest-line{
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
  }

  /* Last match card */
  .last-match-card{
    margin-top:12px;
    background:linear-gradient(135deg,#15171c,#101218);
    border-radius:var(--radius);
    padding:10px 12px;
    border:1px solid #2b323b;
    font-size:13px;
  }
  .last-match-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
  }
  .last-badge{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    padding:2px 6px;
    border-radius:999px;
    background:#22262e;
    color:var(--muted);
  }
  .last-match-main{
    font-size:13px;
  }
  .last-match-meta{
    margin-top:3px;
    font-size:11px;
    color:var(--muted);
  }

  /* Version tag */
  #version-tag{
    position:fixed;
    bottom:6px;
    right:10px;
    font-size:11px;
    color:#666;
    opacity:0.75;
    pointer-events:none;
    user-select:none;
    font-weight:600;
    z-index:99999;
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-bar">
  <div class="header-inner">
    <img src="https://www.matside.org/assets/images/image01.png" class="brand-logo" alt="Matside"/>
    <div class="brand-title">Matside</div>
  </div>
</div>

<div class="wrap">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="brand-mini">
      <img src="https://www.matside.org/assets/images/image01.png" alt="Matside mini"/>
      <div class="brand-mini-title">Control Panel</div>
    </div>

    <div style="display:flex;align-items:center;gap:12px;">
      <div>
        <label for="matSelect" style="font-size:12px;color:var(--muted);">Mat</label><br/>
        <select id="matSelect">
          <option value="1">Mat 1</option>
          <option value="2">Mat 2</option>
          <option value="3">Mat 3</option>
          <option value="4">Mat 4</option>
        </select>
      </div>
      <div class="status">
        Status: <span id="conn">connecting…</span>
      </div>
    </div>
  </div>

  <!-- SUMMARY BAR -->
  <div class="summary">
    <div>Mat: <strong id="sumMat">1</strong></div>
    <div>Period: <strong id="sumSeg">1</strong></div>
    <div>Time: <strong id="sumTime">01:00</strong></div>
    <div>Red: <strong id="sumRed" class="redText">0</strong></div>
    <div>Green: <strong id="sumGreen" class="greenText">0</strong></div>
  </div>

  <!-- LAST MATCH CARD -->
  <div class="last-match-card">
    <div class="last-match-header">
      <div>Last Match Result</div>
      <div class="last-badge">Most Recent</div>
    </div>
    <div class="last-match-main" id="lastMatchMain">
      <em>No match submitted yet.</em>
    </div>
    <div class="last-match-meta" id="lastMatchMeta"></div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div>

      <!-- TIMER CARD -->
      <div class="card">
        <h3>Timer</h3>
        <div class="timer-layout">
          <div class="timer-btn-row">
            <button id="startBtn" class="blue btn-wide">Start</button>
            <button id="stopBtn" class="gray btn-wide">Stop</button>
          </div>
          <div class="timer-btn-row">
            <button id="resetTimerBtn" class="gold btn-wide">Reset Timer</button>
          </div>
          <div class="hint">
            Main clock is shown in the summary bar above. It will gently flash while running.
          </div>
        </div>
      </div>

      <!-- SCORING CARD -->
      <div class="card" style="margin-top:var(--gap);">
        <h3>Scoring</h3>

        <div class="score-columns">

          <!-- RED -->
          <div>
            <div class="status" style="margin-bottom:4px;">Red Wrestler</div>
            <div class="scoring-grid">
              <button class="red small" data-color="red" data-pts="1">E1 (+1)</button>
              <button class="red small" data-color="red" data-pts="2">R2 (+2)</button>
              <button class="red small" data-color="red" data-pts="3">T3 (+3)</button>
              <button class="red small" data-color="red" data-pts="2">N2 (+2)</button>
              <button class="red small" data-color="red" data-pts="3">N3 (+3)</button>
              <button class="red small" data-color="red" data-pts="4">N4 (+4)</button>
            </div>
          </div>

          <!-- GREEN -->
          <div>
            <div class="status" style="margin-bottom:4px;">Green Wrestler</div>
            <div class="scoring-grid">
              <button class="green small" data-color="green" data-pts="1">E1 (+1)</button>
              <button class="green small" data-color="green" data-pts="2">R2 (+2)</button>
              <button class="green small" data-color="green" data-pts="3">T3 (+3)</button>
              <button class="green small" data-color="green" data-pts="2">N2 (+2)</button>
              <button class="green small" data-color="green" data-pts="3">N3 (+3)</button>
              <button class="green small" data-color="green" data-pts="4">N4 (+4)</button>
            </div>
          </div>

        </div>

        <div class="row" style="margin-top:10px;">
          <button id="subRed" class="small gray">-1 Red</button>
          <button id="resetScores" class="small gold">Reset Scores</button>
          <button id="subGreen" class="small gray">-1 Green</button>
        </div>
      </div>

      <!-- NAMES CARD -->
      <div class="card" style="margin-top:var(--gap);">
        <h3>Wrestler Names</h3>
        <div class="names-grid">
          <div>
            <div class="input-label">Red Wrestler</div>
            <input id="redNameInput" class="text-input" type="text" placeholder="Red wrestler name">
          </div>
          <div>
            <div class="input-label">Green Wrestler</div>
            <input id="greenNameInput" class="text-input" type="text" placeholder="Green wrestler name">
          </div>
        </div>
        <div class="hint">
          Names are local to this device for now. We can wire them to the displays later.
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div>

      <!-- END MATCH CARD -->
      <div class="card">
        <h3>End Match</h3>
        <p style="font-size:13px;margin-top:0;">
          Use when the match is finished. The system will suggest a winner and result type based on the score.
        </p>
        <button id="openMatchModalBtn" class="gold btn-wide">End Match &amp; Submit Result</button>
      </div>

      <!-- PERIOD PRESETS -->
      <div class="card" style="margin-top:var(--gap);">
        <h3>Period Presets</h3>
        <div class="pill-row" style="margin-bottom:6px;">
          <button class="pill-btn" data-seg="REG1">P1 (1:00)</button>
          <button class="pill-btn" data-seg="REG2">P2 (1:00)</button>
          <button class="pill-btn" data-seg="REG3">P3 (1:00)</button>
        </div>
        <div class="pill-row">
          <button class="pill-btn" data-seg="OT">OT (1:00)</button>
          <button class="pill-btn" data-seg="TB1">TB1 (0:30)</button>
          <button class="pill-btn" data-seg="TB2">TB2 (0:30)</button>
          <button class="pill-btn" data-seg="UT">UT (0:30)</button>
        </div>
        <div class="hint">
          Changes the current segment and resets the clock to that period's default length.
        </div>
      </div>

      <!-- CUSTOM TIME -->
      <div class="card" style="margin-top:var(--gap);">
        <h3>Custom Time</h3>
        <div class="custom-time-row">
          <input id="customTimeInput" class="text-input" placeholder="MM:SS or seconds (e.g., 1:15 or 75)">
          <button id="applyCustomTimeBtn" class="blue">Apply</button>
        </div>
        <div class="hint">
          Sets a custom time for the current period only. Useful for corrections.
        </div>
      </div>

      <!-- RESET MAT -->
      <div class="card" style="margin-top:var(--gap);">
        <h3>Reset Mat</h3>
        <button id="resetMatBtn" class="red btn-wide">Reset Entire Mat</button>
        <div class="hint">
          Resets period to P1, time to 1:00, scores to 0, and clears the timeline.
        </div>
      </div>

      <!-- TIMELINE -->
      <div class="card" style="margin-top:var(--gap);">
        <h3>Match Timeline</h3>
        <div id="timelineBox"></div>
      </div>

    </div>

  </div>
</div>

<!-- MATCH MODAL -->
<div id="matchModalBackdrop">
  <div class="modal">
    <h3>End Match</h3>

    <div class="modal-section">
      <h4>Suggested</h4>
      <div id="suggestLine" class="suggest-line">
        Suggestion will appear here…
      </div>
    </div>

    <div class="modal-section">
      <h4>Winner</h4>
      <div class="pill-row">
        <button class="pill-btn" id="winnerRedBtn" data-winner="red">Red</button>
        <button class="pill-btn" id="winnerGreenBtn" data-winner="green">Green</button>
      </div>
    </div>

    <div class="modal-section">
      <h4>Result Type</h4>
      <div class="pill-row">
        <button class="pill-btn" data-method="decision">Decision</button>
        <button class="pill-btn" data-method="tech_fall">Tech Fall</button>
        <button class="pill-btn" data-method="pin">Pin</button>
        <button class="pill-btn" data-method="forfeit">Forfeit</button>
      </div>
    </div>

    <div class="modal-section">
      <h4>Confirm</h4>
      <div class="row">
        <button id="confirmMatchBtn" class="blue" style="flex:1;">Submit</button>
        <button id="cancelMatchBtn" class="gray" style="flex:1;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast">
  <span id="toastText">Saved</span>
</div>

<div id="version-tag">Control v4.0 (Monolithic)</div>

<script>
  // =========================
  // Basic socket + state
  // =========================
  const SERVER_URL = "https://scoreboard-server-er33.onrender.com";
  const socket = io(SERVER_URL, { transports:["websocket","polling"] });

  let mats = {};
  let currentMat = 1;

  const matSelect   = document.getElementById("matSelect");
  const connEl      = document.getElementById("conn");
  const sumMatEl    = document.getElementById("sumMat");
  const sumSegEl    = document.getElementById("sumSeg");
  const sumTimeEl   = document.getElementById("sumTime");
  const sumRedEl    = document.getElementById("sumRed");
  const sumGreenEl  = document.getElementById("sumGreen");
  const timelineBox = document.getElementById("timelineBox");

  const redNameInput   = document.getElementById("redNameInput");
  const greenNameInput = document.getElementById("greenNameInput");

  const toastEl      = document.getElementById("toast");
  const toastTextEl  = document.getElementById("toastText");

  const SEGMENTS = {
    REG1:{ id:"REG1", period:1, time:60 },
    REG2:{ id:"REG2", period:2, time:60 },
    REG3:{ id:"REG3", period:3, time:60 },
    OT:{   id:"OT",   period:4, time:60 },
    TB1:{  id:"TB1",  period:5, time:30 },
    TB2:{  id:"TB2",  period:6, time:30 },
    UT:{   id:"UT",   period:7, time:30 }
  };

  function prettySegment(seg){
    if(!seg) return "";
    if(seg.startsWith("REG")) return seg.replace("REG","");
    if(seg.startsWith("OT")) return "OT";
    if(seg.startsWith("TB")) return seg.toUpperCase();
    if(seg.startsWith("UT")) return "UT";
    return seg;
  }

  function formatTime(sec){
    const s = Math.max(0, Math.floor(sec||0));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }

  function getMatState(){
    return mats[currentMat] || null;
  }

  function renderSummary(){
    const m = getMatState();
    if(!m) return;
    sumMatEl.textContent   = String(currentMat);
    sumSegEl.textContent   = prettySegment(m.segmentId || (`REG${m.period||1}`));
    sumTimeEl.textContent  = formatTime(m.time);
    sumRedEl.textContent   = String(m.red || 0);
    sumGreenEl.textContent = String(m.green || 0);

    // Flash timer while running on this mat
    if(m.running){
      sumTimeEl.classList.add("timer-running");
    }else{
      sumTimeEl.classList.remove("timer-running");
    }
  }

  function renderTimeline(){
    const m = getMatState();
    const list = (m && Array.isArray(m.timeline)) ? m.timeline : [];
    if(!list.length){
      timelineBox.innerHTML = `<div class="timeline-item"><em>No events yet.</em></div>`;
      return;
    }
    timelineBox.innerHTML = list.map(item=>{
      if(typeof item === "string"){
        return `<div class="timeline-item">${item}</div>`;
      }
      if(item && item.text){
        const t = new Date(item.ts||Date.now()).toLocaleTimeString();
        return `<div class="timeline-item">
          <div>${item.text}</div>
          <div class="timeline-meta">${t}</div>
        </div>`;
      }
      return `<div class="timeline-item">${String(item)}</div>`;
    }).join("");
  }

  function showToast(message){
    toastTextEl.textContent = message;
    toastEl.style.display = "flex";
    setTimeout(()=>{ toastEl.style.display = "none"; }, 2500);
  }

  socket.on("connect",()=>{
    connEl.textContent = "connected";
    // register for hub, if used
    socket.emit("registerDevice",{ type:"control", mat:currentMat });
  });
  socket.on("disconnect",()=>{
    connEl.textContent = "disconnected";
  });

  socket.on("stateUpdate",(state)=>{
    if(!state || !state.mats) return;
    mats = state.mats;
    renderSummary();
    renderTimeline();
  });

  // Heartbeat so hub can see this device
  setInterval(()=>{
    if(!socket.connected) return;
    socket.emit("heartbeat",{
      type:"control",
      mat:currentMat,
      ts:Date.now()
    });
  }, 10000);

  // Mat selection
  matSelect.addEventListener("change",()=>{
    currentMat = parseInt(matSelect.value,10) || 1;
    renderSummary();
    renderTimeline();
  });

  // ============ TIMER ============
  document.getElementById("startBtn").addEventListener("click",()=>{
    socket.emit("updateState",{ mat:currentMat, updates:{ running:true }});
  });
  document.getElementById("stopBtn").addEventListener("click",()=>{
    socket.emit("updateState",{ mat:currentMat, updates:{ running:false }});
  });
  document.getElementById("resetTimerBtn").addEventListener("click",()=>{
    const m = getMatState() || {};
    const t = (typeof m.segmentDefaultTime === "number") ? m.segmentDefaultTime : 60;
    socket.emit("updateState",{ mat:currentMat, updates:{ time:t, running:false }});
  });

  // ============ SCORING ============
  document.querySelectorAll("[data-color][data-pts]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const color = btn.getAttribute("data-color");
      const pts   = parseInt(btn.getAttribute("data-pts")||"0",10);
      if(!color || !pts) return;
      socket.emit("addPoints",{ mat:currentMat, color, pts });
    });
  });

  document.getElementById("subRed").addEventListener("click",()=>{
    socket.emit("subPoint",{ mat:currentMat, color:"red" });
  });
  document.getElementById("subGreen").addEventListener("click",()=>{
    socket.emit("subPoint",{ mat:currentMat, color:"green" });
  });
  document.getElementById("resetScores").addEventListener("click",()=>{
    socket.emit("updateState",{ mat:currentMat, updates:{ red:0, green:0 }});
  });

  // ============ PERIOD PRESETS ============
  document.querySelectorAll(".pill-btn[data-seg]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const key = btn.getAttribute("data-seg");
      const seg = SEGMENTS[key];
      if(!seg) return;
      const updates = {
        segmentId:seg.id,
        period:seg.period,
        time:seg.time,
        segmentDefaultTime:seg.time,
        running:false
      };
      socket.emit("updateState",{ mat:currentMat, updates });
      showToast(`Set segment: ${key}`);
    });
  });

  // ============ CUSTOM TIME ============
  document.getElementById("applyCustomTimeBtn").addEventListener("click",()=>{
    const val = document.getElementById("customTimeInput").value.trim();
    if(!val) return;
    let seconds = 0;

    if(val.includes(":")){
      const parts = val.split(":");
      if(parts.length !== 2){
        showToast("Invalid format");
        return;
      }
      const mm = parseInt(parts[0],10);
      const ss = parseInt(parts[1],10);
      if(isNaN(mm)||isNaN(ss)||mm<0||ss<0||ss>=60){
        showToast("Invalid MM:SS");
        return;
      }
      seconds = mm*60 + ss;
    }else{
      const s = parseInt(val,10);
      if(isNaN(s)||s<0){
        showToast("Invalid seconds");
        return;
      }
      seconds = s;
    }

    socket.emit("updateState",{
      mat:currentMat,
      updates:{
        time:seconds,
        segmentDefaultTime:seconds,
        running:false
      }
    });
    showToast(`Custom time set: ${formatTime(seconds)}`);
  });

  // ============ RESET MAT ============
  document.getElementById("resetMatBtn").addEventListener("click",()=>{
    const updates = {
      period:1,
      segmentId:"REG1",
      time:60,
      segmentDefaultTime:60,
      running:false,
      red:0,
      green:0,
      timeline:[]
    };
    socket.emit("updateState",{ mat:currentMat, updates });
    redNameInput.value   = "";
    greenNameInput.value = "";
    showToast("Mat reset");
  });

  // ============ NAMES (local only) ============
  redNameInput.addEventListener("change",()=>{
    showToast("Red name updated (local only)");
  });
  greenNameInput.addEventListener("change",()=>{
    showToast("Green name updated (local only)");
  });

  // ============ MATCH END MODAL & AUTOSUGGEST ============
  const matchModalBackdrop = document.getElementById("matchModalBackdrop");
  const openMatchModalBtn  = document.getElementById("openMatchModalBtn");
  const cancelMatchBtn     = document.getElementById("cancelMatchBtn");
  const confirmMatchBtn    = document.getElementById("confirmMatchBtn");
  const winnerRedBtn       = document.getElementById("winnerRedBtn");
  const winnerGreenBtn     = document.getElementById("winnerGreenBtn");
  const methodButtons      = Array.from(document.querySelectorAll(".pill-btn[data-method]"));
  const suggestLineEl      = document.getElementById("suggestLine");

  let selectedWinner = null;
  let selectedMethod = "decision";

  function openMatchModal(){
    const m = getMatState() || {};
    const red   = m.red || 0;
    const green = m.green || 0;
    const diff  = Math.abs(red - green);

    let suggestedWinner = null;
    let suggestedMethod = "decision";
    let suggestText = "No clear suggestion (tie or no score).";

    if(red > green){
      suggestedWinner = "red";
      if(diff >= 15){
        suggestedMethod = "tech_fall";
        suggestText = `Suggested: Red wins by Tech Fall (+${diff}).`;
      }else{
        suggestedMethod = "decision";
        suggestText = `Suggested: Red wins by Decision (${red}–${green}).`;
      }
    }else if(green > red){
      suggestedWinner = "green";
      if(diff >= 15){
        suggestedMethod = "tech_fall";
        suggestText = `Suggested: Green wins by Tech Fall (+${diff}).`;
      }else{
        suggestedMethod = "decision";
        suggestText = `Suggested: Green wins by Decision (${green}–${red}).`;
      }
    }

    suggestLineEl.textContent = suggestText;

    // Pre-select
    selectedWinner = suggestedWinner;
    selectedMethod = suggestedMethod;

    winnerRedBtn.classList.toggle("active", selectedWinner === "red");
    winnerGreenBtn.classList.toggle("active", selectedWinner === "green");
    methodButtons.forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.method === selectedMethod);
    });

    matchModalBackdrop.classList.add("open");
  }

  function closeMatchModal(){
    matchModalBackdrop.classList.remove("open");
  }

  openMatchModalBtn.addEventListener("click", openMatchModal);
  cancelMatchBtn.addEventListener("click", closeMatchModal);

  winnerRedBtn.addEventListener("click",()=>{
    selectedWinner = "red";
    winnerRedBtn.classList.add("active");
    winnerGreenBtn.classList.remove("active");
  });
  winnerGreenBtn.addEventListener("click",()=>{
    selectedWinner = "green";
    winnerGreenBtn.classList.add("active");
    winnerRedBtn.classList.remove("active");
  });

  methodButtons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      selectedMethod = btn.dataset.method;
      methodButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    });
  });

  const lastMatchMainEl = document.getElementById("lastMatchMain");
  const lastMatchMetaEl = document.getElementById("lastMatchMeta");

  confirmMatchBtn.addEventListener("click",()=>{
    const m = getMatState() || {};
    const red   = m.red || 0;
    const green = m.green || 0;

    if(!selectedWinner){
      showToast("Select a winner first.");
      return;
    }
    if(!selectedMethod){
      selectedMethod = "decision";
    }

    const segment = m.segmentId || (`REG${m.period||1}`);

    const payload = {
      mat:currentMat,
      winner:selectedWinner,
      method:selectedMethod,
      redScore:red,
      greenScore:green,
      segmentId:segment,
      ts:Date.now()
    };

    socket.emit("matchEnded", payload);

    // Append basic timeline entry client-side
    const nowText = new Date(payload.ts).toLocaleTimeString();
    const newLine = {
      text:`Match ended: ${selectedWinner.toUpperCase()} by ${selectedMethod.replace("_"," ")} (${red}–${green})`,
      ts:payload.ts
    };

    const current = getMatState() || {};
    const existing = Array.isArray(current.timeline) ? current.timeline.slice() : [];
    existing.push(newLine);

    socket.emit("updateState",{
      mat:currentMat,
      updates:{ timeline:existing }
    });

    // Update "Last match" card
    const winnerName =
      selectedWinner === "red"
        ? (redNameInput.value.trim() || "Red wrestler")
        : (greenNameInput.value.trim() || "Green wrestler");

    lastMatchMainEl.textContent =
      `${winnerName} wins by ${selectedMethod.replace("_"," ")} (${red}–${green})`;

    lastMatchMetaEl.textContent =
      `Mat ${currentMat}, Segment ${prettySegment(segment)} — ${nowText}`;

    // Auto-reset mat after submission
    const resetUpdates = {
      period:1,
      segmentId:"REG1",
      time:60,
      segmentDefaultTime:60,
      running:false,
      red:0,
      green:0,
      timeline:[...existing, { text:"Mat auto-reset after match submission.", ts:Date.now() }]
    };
    socket.emit("updateState",{ mat:currentMat, updates:resetUpdates });

    closeMatchModal();
    showToast("Match submitted & mat reset");
  });
</script>

</body>
</html>
