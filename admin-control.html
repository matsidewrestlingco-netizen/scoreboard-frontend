<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Control â€“ Match Upload & Assignment</title>

  <!-- PapaParse CSV Parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <!-- SortableJS for drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }

    h2, h3 { margin-top: 0; }

    .section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 1100px;
      margin: 30px auto;
    }

    .pill-btn-fat {
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      background: #0077ff;
      color: white;
      transition: 0.2s;
    }

    .pill-btn-fat:disabled {
      background: #9bbcf0;
      cursor: not-allowed;
    }

    .csv-preview {
      margin-top: 20px;
      max-height: 350px;
      overflow-y: auto;
    }

    .csv-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    .csv-table th,
    .csv-table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      vertical-align: top;
    }

    .csv-table th {
      background: #e7e7e7;
      font-weight: bold;
    }

    /* Toast System */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      display: flex;
      align-items: center;
      background-color: #333;
      color: #fff;
      padding: 12px 18px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(-10px);
      animation: fadeInUp 0.3s forwards, fadeOut 0.4s 2.4s forwards;
    }

    .toast.success {
      background-color: #28a745;
    }

    .toast.error {
      background-color: #dc3545;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; transform: translateY(-10px); }
    }

    /* Loading Bar */
    .loading-bar {
      width: 100%;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }

    .loading-bar-inner {
      width: 0%;
      height: 100%;
      background: #0077ff;
      animation: loadingAnim 1.2s infinite;
    }

    @keyframes loadingAnim {
      0% { width: 0%; }
      50% { width: 80%; }
      100% { width: 0%; }
    }

    /* Drag & Drop Layout */
    .drag-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    .list-column {
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      max-height: 500px;
    }

    .list-column h3 {
      margin: 0;
      padding: 10px;
      font-size: 14px;
      text-align: center;
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
    }

    .match-list {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      min-height: 50px;
    }

    .match-card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      cursor: grab;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .match-card.dragging {
      opacity: 0.6;
    }

    .match-card-header {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .match-card-body {
      line-height: 1.3;
    }

    .match-card-meta {
      margin-top: 4px;
      font-size: 11px;
      color: #555;
    }
  </style>

</head>
<body>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer"></div>

  <!-- SECTION 1: CSV UPLOAD -->
  <div class="section">
    <h2>Upload Matches (CSV)</h2>
    <p>Select a CSV file containing match data.</p>

    <input type="file" id="matchCsvInput" accept=".csv" />
    <br><br>
    <button id="parseCsvBtn" class="pill-btn-fat" disabled>Parse CSV</button>

    <div id="csvPreview" class="csv-preview"></div>
  </div>

  <!-- SECTION 2: MATCH ASSIGNMENT (DRAG & DROP) -->
  <div class="section">
    <h2>Assign Matches to Mats (Drag & Drop)</h2>

    <button id="loadMatchesBtn" class="pill-btn-fat">Load Matches from Cloud</button>

    <div id="loadingBar" class="loading-bar">
      <div class="loading-bar-inner"></div>
    </div>

    <div id="assignmentBoard" class="csv-preview"></div>
  </div>

  <script>
    /////////////////////////////////////////////////////////////////////////////
    // ðŸ”¥ FIREBASE INITIALIZATION
    /////////////////////////////////////////////////////////////////////////////
    const firebaseConfig = {
      apiKey: "AIzaSyD_uk47fURmQiHZnN8avfcGoNObMntdu_s",
      authDomain: "matsidewrestlingco-fb85f.firebaseapp.com",
      projectId: "matsidewrestlingco-fb85f",
      storageBucket: "matsidewrestlingco-fb85f.firebasestorage.app",
      messagingSenderId: "898197416726",
      appId: "1:898197416726:web:921ccbd0f63f7fd6537e37"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /////////////////////////////////////////////////////////////////////////////
    // TOAST SYSTEM
    /////////////////////////////////////////////////////////////////////////////
    function showToast(message, type = "success") {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = "toast " + type;
      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    /////////////////////////////////////////////////////////////////////////////
    // STEP 1 â€” CSV UPLOAD + PARSE
    /////////////////////////////////////////////////////////////////////////////
    let uploadedCsvFile = null;
    let parsedMatches = [];

    document.getElementById("matchCsvInput").addEventListener("change", (e) => {
      uploadedCsvFile = e.target.files[0];
      document.getElementById("parseCsvBtn").disabled = !uploadedCsvFile;
    });

    document.getElementById("parseCsvBtn").addEventListener("click", () => {
      if (!uploadedCsvFile) return;

      Papa.parse(uploadedCsvFile, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          parsedMatches = results.data.map(row => {
            return {
              id: crypto.randomUUID(),
              bout: row.bout || row.Bout || "",
              weight: row.weight || row.Weight || "",
              round: row.round || row.Round || "",
              preferredMat: Number(row.mat || row.Mat || 0),

              red: {
                name: row.redName || row.RedName || row.Red || "",
                team: row.redTeam || row.RedTeam || ""
              },
              green: {
                name: row.greenName || row.GreenName || row.Green || "",
                team: row.greenTeam || row.GreenTeam || ""
              },

              assignedMat: null,
              queueIndex: null,
              status: "upcoming"
            };
          });

          showCsvPreview(parsedMatches);
        }
      });
    });

    /////////////////////////////////////////////////////////////////////////////
    // CSV PREVIEW TABLE
    /////////////////////////////////////////////////////////////////////////////
    function showCsvPreview(matches) {
      const container = document.getElementById("csvPreview");

      if (!matches.length) {
        container.innerHTML = "<p>No matches parsed.</p>";
        return;
      }

      let html = `
        <h3>Preview (${matches.length} matches)</h3>
        <table class="csv-table">
          <tr>
            <th>Bout</th>
            <th>Weight</th>
            <th>Red Wrestler</th>
            <th>Green Wrestler</th>
            <th>Round</th>
            <th>Mat Pref</th>
          </tr>
      `;

      matches.slice(0, 50).forEach(m => {
        html += `
          <tr>
            <td>${m.bout}</td>
            <td>${m.weight}</td>
            <td>${m.red.name} (${m.red.team})</td>
            <td>${m.green.name} (${m.green.team})</td>
            <td>${m.round}</td>
            <td>${m.preferredMat || "-"}</td>
          </tr>
        `;
      });

      html += "</table><br>";

      html += `
        <button id="saveToCloudBtn" class="pill-btn-fat">Save Matches to Cloud</button>
      `;

      container.innerHTML = html;

      document.getElementById("saveToCloudBtn")
        .addEventListener("click", saveMatchesToCloud);
    }

    /////////////////////////////////////////////////////////////////////////////
    // SAVE MATCHES TO FIRESTORE
    /////////////////////////////////////////////////////////////////////////////
    function saveMatchesToCloud() {
      if (!parsedMatches.length) {
        showToast("No matches to save.", "error");
        return;
      }

      const batch = db.batch();
      const matchCollection = db.collection("matchLibrary");

      parsedMatches.forEach(match => {
        const docRef = matchCollection.doc(match.id);
        batch.set(docRef, match);
      });

      batch.commit()
        .then(() => showToast("Matches saved to cloud!", "success"))
        .catch(err => {
          console.error(err);
          showToast("Error saving matches.", "error");
        });
    }

    /////////////////////////////////////////////////////////////////////////////
    // STEP 3 â€” LOAD MATCHES FOR DRAG & DROP ASSIGNMENT
    /////////////////////////////////////////////////////////////////////////////
    document.getElementById("loadMatchesBtn").addEventListener("click", loadMatchesFromCloud);

    function loadMatchesFromCloud() {
      const loadingBar = document.getElementById("loadingBar");
      loadingBar.style.display = "block";

      db.collection("matchLibrary")
        .get()
        .then(snapshot => {
          const matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          showAssignmentBoard(matches);
          showToast("Matches loaded!", "success");
        })
        .catch(err => {
          console.error(err);
          showToast("Error loading matches.", "error");
        })
        .finally(() => {
          loadingBar.style.display = "none";
        });
    }

    /////////////////////////////////////////////////////////////////////////////
    // DRAG & DROP ASSIGNMENT BOARD
    /////////////////////////////////////////////////////////////////////////////
    let dragInitialized = false;

    function showAssignmentBoard(matches) {
      const container = document.getElementById("assignmentBoard");

      if (!matches.length) {
        container.innerHTML = "<p>No matches found in cloud.</p>";
        return;
      }

      // Build column layout: Unassigned + Mats 1â€“4
      let html = `
        <div class="drag-container">
          <div class="list-column">
            <h3>Unassigned</h3>
            <div id="mat-0" class="match-list"></div>
          </div>
          <div class="list-column">
            <h3>Mat 1</h3>
            <div id="mat-1" class="match-list"></div>
          </div>
          <div class="list-column">
            <h3>Mat 2</h3>
            <div id="mat-2" class="match-list"></div>
          </div>
          <div class="list-column">
            <h3>Mat 3</h3>
            <div id="mat-3" class="match-list"></div>
          </div>
          <div class="list-column">
            <h3>Mat 4</h3>
            <div id="mat-4" class="match-list"></div>
          </div>
        </div>
      `;

      container.innerHTML = html;

      // Group matches by assignedMat
      const columns = {
        0: [],
        1: [],
        2: [],
        3: [],
        4: []
      };

      matches.forEach(m => {
        const mat = m.assignedMat || 0;
        columns[mat].push(m);
      });

      // Sort each column by queueIndex, then bout
      Object.keys(columns).forEach(matKey => {
        columns[matKey].sort((a, b) => {
          const qa = (a.queueIndex !== null && a.queueIndex !== undefined) ? a.queueIndex : 9999;
          const qb = (b.queueIndex !== null && b.queueIndex !== undefined) ? b.queueIndex : 9999;
          if (qa !== qb) return qa - qb;
          const ba = Number(a.bout) || 0;
          const bb = Number(b.bout) || 0;
          return ba - bb;
        });
      });

      // Render match cards into each list
      Object.keys(columns).forEach(matKey => {
        const listEl = document.getElementById(`mat-${matKey}`);
        const listMatches = columns[matKey];

        listMatches.forEach(m => {
          const card = document.createElement("div");
          card.className = "match-card";
          card.setAttribute("data-id", m.id);

          card.innerHTML = `
            <div class="match-card-header">
              Bout ${m.bout || "-"} â€“ ${m.weight || "?"} lbs
            </div>
            <div class="match-card-body">
              <div>${m.red.name || "Red"} (${m.red.team || ""})</div>
              <div>vs</div>
              <div>${m.green.name || "Green"} (${m.green.team || ""})</div>
            </div>
            <div class="match-card-meta">
              Round: ${m.round || "-"}
            </div>
          `;

          listEl.appendChild(card);
        });
      });

      // Initialize SortableJS once
      if (!dragInitialized) {
        const matIds = [0, 1, 2, 3, 4];

        matIds.forEach(matNum => {
          const listEl = document.getElementById(`mat-${matNum}`);

          Sortable.create(listEl, {
            group: "mats",
            animation: 150,
            ghostClass: "dragging",
            onEnd: handleDragEnd
          });
        });

        dragInitialized = true;
      }
    }

    /////////////////////////////////////////////////////////////////////////////
    // HANDLE DRAG END â€” UPDATE FIRESTORE (assignedMat + queueIndex)
    /////////////////////////////////////////////////////////////////////////////
    function handleDragEnd(evt) {
      const toListId = evt.to.id;       // e.g., 'mat-2'
      const toMatNum = Number(toListId.split("-")[1]); // 0â€“4

      const matchCollection = db.collection("matchLibrary");
      const batch = db.batch();
      const matIds = [0, 1, 2, 3, 4];

      matIds.forEach(matNum => {
        const listEl = document.getElementById(`mat-${matNum}`);
        if (!listEl) return;

        const children = Array.from(listEl.children);
        children.forEach((cardEl, index) => {
          const id = cardEl.getAttribute("data-id");
          if (!id) return;

          const docRef = matchCollection.doc(id);
          const assignedMat = matNum === 0 ? null : matNum;
          const queueIndex = index;

          batch.update(docRef, { assignedMat, queueIndex });
        });
      });

      batch.commit()
        .then(() => {
          showToast("Mat assignments updated!", "success");
        })
        .catch(err => {
          console.error(err);
          showToast("Error updating assignments.", "error");
        });
    }

  </script>

</body>
</html>
