<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Matside — Admin Control Panel</title>

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<!-- Sortable -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* ----------------------------------------- */
/* GLOBAL DARK DASHBOARD THEME (Option A)    */
/* ----------------------------------------- */

body {
  margin: 0;
  padding: 20px;
  background: #1a1a1a;
  font-family: "Inter", sans-serif;
  color: #e6e6e6;
}

h2 {
  margin: 0 0 16px;
  font-size: 20px;
}

.section {
  margin-bottom: 24px;
  padding: 16px;
  border-radius: 12px;
  background: #222;
  border: 1px solid rgba(255,255,255,0.05);
}

label {
  font-size: 13px;
}

input[type="text"],
input[type="number"],
input[type="date"],
select {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #444;
  background: #181818;
  color: white;
  font-size: 13px;
}

input[type="file"] {
  color: #ddd;
}

/* Preview table */
#csvPreview table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 12px;
}
#csvPreview th,
#csvPreview td {
  border: 1px solid #333;
  padding: 4px 6px;
  text-align: left;
}
#csvPreview th {
  background: #333;
}

/* Match library / board layout */
.flex {
  display: flex;
  gap: 16px;
}
.column {
  flex: 1;
}

.card {
  background: #262626;
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.08);
}

.card h3 {
  margin: 0 0 8px;
  font-size: 16px;
}

.card-sub {
  font-size: 12px;
  color: #b3b3b3;
  margin-bottom: 8px;
}

/* Mat columns */
.mats-row {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 8px;
}

.mat-column {
  background: #252525;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.08);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.mat-header {
  padding: 6px 8px;
  font-size: 13px;
  background: #333;
  border-bottom: 1px solid #444;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mat-header span {
  font-weight: 600;
}

.mat-count {
  font-size: 12px;
  color: #ccc;
}

.match-card {
  background: #2b2b2b;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
  padding: 6px 7px;
  font-size: 11px;
  margin-bottom: 6px;
  cursor: grab;
}

.match-card.assigned {
  background: #283593;
  border-color: #5c6bc0;
}

.match-main {
  font-weight: 600;
  margin-bottom: 2px;
}

.match-meta {
  font-size: 10px;
  color: #b0bec5;
}

.match-id {
  font-size: 10px;
  opacity: 0.8;
}

/* Assignment board scroll */
.assignment-board {
  max-height: 420px;
  overflow-y: auto;
}

/* Toast container */
#toastContainer {
  position: fixed;
  right: 16px;
  bottom: 16px;
  z-index: 9999;
}

.toast {
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  margin-top: 4px;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
}

/* Buttons */
.pill-btn-fat {
  padding: 10px 20px;
  border-radius: 24px;
  border: none;
  background: #3a77ff;
  color: white;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
}

.pill-btn-fat.secondary {
  background: #444;
}

.pill-btn-fat.danger {
  background: #c62828;
}

/* Controls row */
.controls-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

/* TABS */
.tab-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.tab-button {
  padding: 6px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.12);
  background: #262626;
  color: #dddddd;
  font-size: 13px;
  cursor: pointer;
}
.tab-button.active {
  background: #3a77ff;
  border-color: #3a77ff;
  color: #ffffff;
}
.tab-panel {
  display: none;
}
.tab-panel.active {
  display: block;
}
</style>
</head>
<body>

<!-- Toasts -->
<div id="toastContainer"></div>


<div class="tab-bar">
  <button class="tab-button active" data-tab="admin">Admin</button>
  <button class="tab-button" data-tab="hub">Hub</button>
</div>

<div id="tab-admin" class="tab-panel active">
<!-- ---------------- SECTION: CSV UPLOAD ---------------- -->
<div class="section">
  <h2>Upload Matches (CSV)</h2>

  <input type="file" id="matchCsvInput" accept=".csv" />
  <br><br>

  <button id="parseCsvBtn" class="pill-btn-fat" disabled>Parse CSV</button>

  <div id="csvPreview"></div>
</div>

<!-- ---------------- SECTION: EVENT & LIBRARY ---------------- -->
<div class="section">
  <h2>Event & Match Library</h2>

  <div class="controls-row">
    <div>
      <label for="eventSelect">Active Event:</label><br />
      <select id="eventSelect"></select>
    </div>

    <div>
      <button id="loadLibraryBtn" class="pill-btn-fat secondary">Load Match Library</button>
    </div>

    <div>
      <button id="createEventBtn" class="pill-btn-fat secondary">Create New Event</button>
    </div>
  </div>

  <div class="flex">
    <div class="column">
      <div class="card">
        <h3>Match Library</h3>
        <div class="card-sub">
          Drag from here into mat columns to assign matches.
        </div>
        <div id="matchLibrary" class="assignment-board"></div>
      </div>
    </div>
    <div class="column" style="flex:2;">
      <div class="card">
        <h3>Mat Assignment Board</h3>
        <div class="card-sub">
          Mat 0 = Unassigned / Backlog. Mats 1–4 = live mats.
        </div>

        <div class="controls-row">
          <button id="saveAssignmentBtn" class="pill-btn-fat">Save Assignments</button>
          <button id="clearCompletedBtn" class="pill-btn-fat secondary">Clear Completed</button>
        </div>

        <div class="mats-row" id="assignmentBoard"></div>
      </div>
    </div>
  </div>
</div>
</div>

<div id="tab-hub" class="tab-panel">
  <iframe src="hub.html" style="width:100%;height:80vh;border:none;border-radius:12px;background:#000;"></iframe>
</div>

<script>
/* ---------------------------------------------------- */
/* Firebase Init                                        */
/* ---------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD_uk47fURmQiHZnN8avfcGoNObMntdu_s",
  authDomain: "matsidewrestlingco-fb85f.firebaseapp.com",
  projectId: "matsidewrestlingco-fb85f",
  storageBucket: "matsidewrestlingco-fb85f.firebasestorage.app",
  messagingSenderId: "898197416726",
  appId: "1:898197416726:web:921ccbd0f63f7fd6537e37"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------------------------------------------- */
/* Toast Helper                                         */
/* ---------------------------------------------------- */
function showToast(message, type="info") {
  const container = document.getElementById("toastContainer");
  const el = document.createElement("div");
  el.className = "toast";
  el.textContent = message;
  container.appendChild(el);
  setTimeout(() => {
    container.removeChild(el);
  }, 2500);
}

/* ---------------------------------------------------- */
/* CSV PARSING                                          */
/* ---------------------------------------------------- */
const matchCsvInput = document.getElementById("matchCsvInput");
const parseCsvBtn   = document.getElementById("parseCsvBtn");
const csvPreview    = document.getElementById("csvPreview");

let parsedRows = [];

matchCsvInput.addEventListener("change", () => {
  if (matchCsvInput.files && matchCsvInput.files.length > 0) {
    parseCsvBtn.disabled = false;
  } else {
    parseCsvBtn.disabled = true;
  }
});

parseCsvBtn.addEventListener("click", () => {
  const file = matchCsvInput.files[0];
  if (!file) {
    showToast("No file selected", "error");
    return;
  }

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      parsedRows = results.data;
      renderCsvPreview(parsedRows);
      showToast("CSV parsed. Ready to upload to match library.", "success");
    },
    error: () => {
      showToast("Error parsing CSV", "error");
    }
  });
});

function renderCsvPreview(rows) {
  if (!rows || rows.length === 0) {
    csvPreview.innerHTML = "<em>No rows found</em>";
    return;
  }

  const columns = Object.keys(rows[0]);
  let html = "<table><thead><tr>";
  columns.forEach(col => {
    html += `<th>${col}</th>`;
  });
  html += "</tr></thead><tbody>";
  rows.forEach(row => {
    html += "<tr>";
    columns.forEach(col => {
      html += `<td>${row[col] ?? ""}</td>`;
    });
    html += "</tr>";
  });
  html += "</tbody></table>";
  csvPreview.innerHTML = html;
}

/* ---------------------------------------------------- */
/* EVENT SELECT + MATCH LIBRARY                         */
/* ---------------------------------------------------- */
const eventSelect      = document.getElementById("eventSelect");
const loadLibraryBtn   = document.getElementById("loadLibraryBtn");
const createEventBtn   = document.getElementById("createEventBtn");
const matchLibraryDiv  = document.getElementById("matchLibrary");
const assignmentBoard  = document.getElementById("assignmentBoard");
const saveAssignmentBtn= document.getElementById("saveAssignmentBtn");
const clearCompletedBtn= document.getElementById("clearCompletedBtn");

let currentEventId = null;

function loadEvents() {
  db.collection("events")
    .orderBy("createdAt", "desc")
    .get()
    .then(snapshot => {
      let options = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        options += `<option value="${doc.id}">${data.name || doc.id}</option>`;
      });
      eventSelect.innerHTML = options;
      if (snapshot.docs.length > 0) {
        currentEventId = snapshot.docs[0].id;
        eventSelect.value = currentEventId;
        loadMatchLibrary();
        loadAssignmentsToBoard();
      }
    })
    .catch(() => {
      showToast("Error loading events", "error");
    });
}

eventSelect.addEventListener("change", () => {
  currentEventId = eventSelect.value;
  loadMatchLibrary();
  loadAssignmentsToBoard();
});

/* Create New Event (simple prompt-based flow) */
createEventBtn.addEventListener("click", () => {
  const name = prompt("Event name?");
  if (!name) return;

  const mats = parseInt(prompt("How many mats? (default 4)", "4") || "4", 10) || 4;
  const date = prompt("Event date? (optional, e.g. 2026-01-15)", "");

  db.collection("events").add({
    name,
    mats,
    date: date || null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    showToast("Event created.", "success");
    loadEvents();
  })
  .catch(() => showToast("Error creating event", "error"));
});

/* Load Match Library for current event */
function loadMatchLibrary() {
  if (!currentEventId) return;
  matchLibraryDiv.innerHTML = "<em>Loading…</em>";

  db.collection("events")
    .doc(currentEventId)
    .collection("matches")
    .orderBy("bout")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        matchLibraryDiv.innerHTML = "<em>No matches in this event yet.</em>";
        return;
      }

      let html = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        html += renderMatchCardHtml(doc.id, data, false);
      });
      matchLibraryDiv.innerHTML = html;
    })
    .catch(() => {
      matchLibraryDiv.innerHTML = "<em>Error loading match library.</em>";
      showToast("Error loading match library", "error");
    });
}

/* Load assignments into board (Mat 0–4) */
function loadAssignmentsToBoard() {
  if (!currentEventId) return;
  assignmentBoard.innerHTML = "<em>Loading mats…</em>";

  const matCols = [0,1,2,3,4];
  const promises = matCols.map(mat => {
    return db.collection("events")
      .doc(currentEventId)
      .collection("matches")
      .where("assignedMat", "==", mat)
      .orderBy("queueIndex")
      .get()
      .then(snapshot => {
        return {
          mat,
          docs: snapshot.docs
        };
      });
  });

  Promise.all(promises)
    .then(results => {
      let boardHtml = "";
      results.forEach(group => {
        boardHtml += renderMatColumnHtml(group.mat, group.docs);
      });
      assignmentBoard.innerHTML = boardHtml;
      attachSortable();
    })
    .catch(() => {
      assignmentBoard.innerHTML = "<em>Error loading assignments.</em>";
      showToast("Error loading assignments", "error");
    });
}

/* Render helpers */
function renderMatchCardHtml(id, data, assigned) {
  const bout = data.bout || "";
  const wt   = data.weight || "";
  const r    = data.red || {};
  const g    = data.green || {};

  const redName = r.name || "Red";
  const greenName = g.name || "Green";

  const cls = assigned ? "match-card assigned" : "match-card";

  return `
    <div class="${cls}" data-id="${id}">
      <div class="match-main">Bout ${bout} • ${wt}</div>
      <div class="match-meta">${redName} vs ${greenName}</div>
      <div class="match-id">${id}</div>
    </div>
  `;
}

function renderMatColumnHtml(mat, docs) {
  const matLabel = mat === 0 ? "Mat 0 (Unassigned)" : `Mat ${mat}`;
  const count = docs.length;
  let cardsHtml = "";
  docs.forEach(doc => {
    cardsHtml += renderMatchCardHtml(doc.id, doc.data(), mat !== 0);
  });

  return `
    <div class="mat-column">
      <div class="mat-header">
        <span>${matLabel}</span>
        <span class="mat-count">${count} match${count === 1 ? "" : "es"}</span>
      </div>
      <div class="match-list" id="mat-${mat}">
        ${cardsHtml}
      </div>
    </div>
  `;
}

/* Sortable */
function attachSortable() {
  const mats = [0,1,2,3,4];
  mats.forEach(mat => {
    const el = document.getElementById(`mat-${mat}`);
    if (!el) return;
    new Sortable(el, {
      group: "mats",
      animation: 150
    });
  });
}

/* Save assignments (writes assignedMat + queueIndex) */
saveAssignmentBtn.addEventListener("click", saveAssignmentOrder);

function saveAssignmentOrder() {
  if (!currentEventId) {
    showToast("No event selected", "error");
    return;
  }

  const batch = db.batch();
  const mats = [0,1,2,3,4];

  mats.forEach(mat => {
    const parent = document.getElementById(`mat-${mat}`);
    if (!parent) return;
    [...parent.children].forEach((card, i) => {
      const ref = db.collection("events")
        .doc(currentEventId)
        .collection("matches")
        .doc(card.dataset.id);
      batch.update(ref, {
        assignedMat: mat === 0 ? null : mat,
        queueIndex: i
      });
    });
  });

  batch.commit()
    .then(() => showToast("Order updated!", "success"))
    .catch(() => showToast("Error updating order", "error"));
}

/* Clear completed matches from all mats (optional button) */
clearCompletedBtn.addEventListener("click", () => {
  if (!currentEventId) return;
  if (!confirm("Clear 'completed' matches from all mats?")) return;

  db.collection("events")
    .doc(currentEventId)
    .collection("matches")
    .where("completed", "==", true)
    .get()
    .then(snapshot => {
      const batch = db.batch();
      snapshot.forEach(doc => {
        batch.update(doc.ref, {
          assignedMat: null,
          queueIndex: null
        });
      });
      return batch.commit();
    })
    .then(() => showToast("Cleared completed matches.", "success"))
    .catch(() => showToast("Error clearing completed matches", "error"));
});

/* Initial load */
loadEvents();

// Simple tab switcher for Admin / Hub
document.addEventListener("DOMContentLoaded", () => {
  const tabButtons = Array.from(document.querySelectorAll(".tab-button"));
  const panels = {
    admin: document.getElementById("tab-admin"),
    hub: document.getElementById("tab-hub")
  };

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-tab");
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      Object.keys(panels).forEach(key => {
        if (!panels[key]) return;
        if (key === target) {
          panels[key].classList.add("active");
        } else {
          panels[key].classList.remove("active");
        }
      });
    });
  });
});
</script>

</body>
</html>
